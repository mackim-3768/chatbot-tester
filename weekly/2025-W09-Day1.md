# Daily Framework Planning – 2025-W09-day1

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common / All
- Current limitation: Generator, Runner, Evaluator 모듈 간에 `Message`, `TestSample` 등 핵심 데이터 모델이 중복 정의되어 있으며, 일부는 `dataclass`를 쓰고 일부는 `dict`를 사용하여 타입 안정성이 부족함.
- Proposed improvement: `chatbot_tester.core.types` 모듈을 신설하여 공통 데이터 모델을 중앙에서 정의하고 모든 모듈이 이를 참조하도록 리팩토링함.
- Why this matters for an SDK: 데이터 구조의 일관성을 보장하고, 모듈 간 데이터 전달 시 변환 비용과 오류를 줄여 사용자 경험을 향상함.

### Idea 2
- Affected layer: Configuration
- Current limitation: Runner는 `dataclass` 기반 설정, Evaluator는 `dict` 기반 설정, CLI는 `argparse`를 사용하는 등 설정 관리 방식이 파편화되어 있음.
- Proposed improvement: `pydantic` 또는 `marshmallow` 기반의 통합 설정 스키마(`ConfigLoader`)를 도입하여 YAML/JSON 설정 파일을 일관되게 로드하고 검증함.
- Why this matters for an SDK: 사용자가 하나의 설정 파일로 전체 실험(Generation -> Run -> Eval)을 제어할 수 있게 하여 사용성을 높임.

### Idea 3
- Affected layer: Runner / Generator
- Current limitation: `ChatBackend` 레지스트리가 `runner` 내부에 위치하여, `generator`에서 LLM을 사용해 합성 데이터를 생성할 때 코드를 재사용하기 어려움.
- Proposed improvement: 백엔드 시스템을 `chatbot_tester.core.backends`로 이동하여 Generator와 Runner가 동일한 LLM 클라이언트 로직을 공유하도록 함.
- Why this matters for an SDK: 코드 중복을 제거하고, 새로운 LLM 프로바이더 추가 시 한 곳만 수정하면 되므로 유지보수성이 향상됨.

### Idea 4
- Affected layer: Evaluator
- Current limitation: 평가 지표(Metric)가 내부 레지스트리에 하드코딩되어 있거나 정적으로 정의되어 있어, 사용자가 커스텀 메트릭을 추가하기 어려움.
- Proposed improvement: 명확한 `Evaluator` 인터페이스를 정의하고, 플러그인 시스템(예: `entry_points`)을 도입하여 외부 패키지에서도 메트릭을 등록할 수 있게 함.
- Why this matters for an SDK: 도메인 특화 메트릭이 필요한 사용자들에게 프레임워크의 수정 없이 확장 가능한 구조를 제공함.

### Idea 5
- Affected layer: Common
- Current limitation: 로깅이 각 모듈에서 산발적으로(`print` 또는 개별 `logger`) 처리되어, 구조화된 로그 수집이나 레벨 조정이 어려움.
- Proposed improvement: `chatbot_tester.core.logging`을 도입하여 JSON 구조화 로그 및 표준 로그 레벨 설정을 중앙에서 관리함.
- Why this matters for an SDK: 대규모 테스트 실행 시 디버깅을 용이하게 하고, 외부 관측 도구(Observability tools)와의 연동성을 높임.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: 공통 데이터 모델 통합 (Unified Core Models)
- Primary affected layer(s): Common (Core), All Modules

### Selection Rationale
- Architectural leverage: 데이터 모델은 프레임워크의 언어이므로, 이를 통일하는 것이 다른 모든 개선(설정 통합, 백엔드 공유 등)의 기초가 됨.
- Impact on extensibility / reuse: 모듈 간 명확한 인터페이스 계약(Contract)을 수립하여 결합도를 낮추고 재사용성을 높임.
- Reduction of future complexity: 중복 코드를 제거하여 유지보수 부담을 줄이고 버그 발생 가능성을 원천 차단함.

### Deferred Ideas (Brief)
- Idea 2 (Config): 데이터 모델이 안정화된 후 적용하는 것이 효율적임.
- Idea 3 (Backend): 데이터 모델 이동 후 자연스럽게 이어지는 후속 작업임.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
공통 데이터 모델 통합 (Unified Core Models)

### Problem Statement
- 현재 `runner/models.py`, `generator/types.py`, `evaluator/domain.py`에 `Message`, `TestSample` 등이 중복 정의되어 있음.
- Evaluator는 `dict`를 주로 사용하여 타입 힌팅의 이점을 누리지 못하고, 필드명 오타 등의 런타임 오류 위험이 있음.
- 라이브러리 사용자 입장에서는 모듈 간 데이터 변환을 수동으로 해야 하는 불편함이 있음.

### Design Approach (High-level)
- Core concept: "Single Source of Truth" 원칙을 적용하여 `src/chatbot_tester/core/types.py`에 모든 도메인 모델을 정의함.
- Key abstractions or interfaces:
  - `Message`: 역할(role), 내용(content), 메타데이터 등을 포함하는 대화의 기본 단위.
  - `TestSample`: `id`, `messages` 리스트, `expected` 결과 등을 포함하는 테스트 케이스.
  - `RunResult`: 실행 결과, 레이턴시, 토큰 사용량 등을 포함.
- Expected behavior:
  - Generator는 `core.types.TestSample` 객체를 생성.
  - Runner는 `core.types.TestSample`을 입력받아 `core.types.RunResult`를 반환.
  - Evaluator는 `core.types.RunResult`를 입력받아 평가 수행.

### MVP Scope
- Included in MVP:
  - `src/chatbot_tester/core` 패키지 생성.
  - `Message`, `TestSample` 클래스 이동 및 통합 (`dataclass` 활용).
  - Generator, Runner, Evaluator의 import 경로 수정 및 코드 호환성 확보.
- Explicitly excluded:
  - `RunConfig` 등 설정 관련 클래스 통합 (별도 이슈로 처리).
  - 데이터베이스 마이그레이션 (현재는 파일 기반이므로 불필요).

### Optional / Future Extensions
- `pydantic` 모델로 전환하여 직렬화/역직렬화 편의성 증대.
- 불변성(Immutability) 강화를 위한 `frozen=True` 적용 검토.

### Acceptance Criteria
- [ ] `src/chatbot_tester/core/types.py`가 생성되고 주요 모델이 정의됨.
- [ ] `generator`, `runner`, `evaluator` 모듈이 더 이상 자체 모델을 정의하지 않고 `core`를 참조함.
- [ ] 기존 유닛 테스트가 수정 없이(또는 최소한의 수정으로) 통과함.
- [ ] `example/quickstart/run_quickstart.sh` 스크립트가 정상 동작함.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Daily][2025-W09-day1] 공통 데이터 모델(core.types) 통합 및 리팩토링`

### Task Breakdown
- [ ] Core implementation
  - Module: `src/chatbot_tester/core/types.py`
  - Summary: `Message`, `TestSample`, `RunResult` 클래스를 정의하고 `to_dict`, `from_dict` 메서드를 표준화함.
- [ ] Refactoring
  - Module: `runner`, `generator`, `evaluator`
  - Summary: 각 모듈의 로컬 모델 정의를 제거하고 `core.types` import로 변경.
- [ ] Tests
  - Unit / Integration: 변경된 모델 경로를 반영하여 테스트 코드 수정 및 실행.
- [ ] Documentation
  - Docstrings: 새로운 Core 모델에 대한 문서화 추가.

### Notes
- Backward compatibility concerns: 내부 API 변경이므로 라이브러리 사용자에게는 Breaking Change가 될 수 있음. 버전 범프(Minor update) 필요.
- Refactoring risk: `Evaluator`가 `dict`에 의존하는 부분이 많아 변경 범위가 클 수 있으므로 주의 필요.

---

## 5. Docs / Notes

### README Updates
- 추가 섹션: "Architecture - Core Models"
- 핵심 메시지: "모든 모듈은 `chatbot_tester.core`의 데이터 모델을 공유하여 일관성을 유지합니다."

### Example Snippet (Optional)

```python
# Before
from chatbot_tester.runner.models import TestSample
from chatbot_tester.generator.types import Message

# After
from chatbot_tester.core.types import TestSample, Message
```
