# Daily Framework Planning – 2025-W06-day2

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common (Shared)
- Current limitation: `generator`와 `runner` 모듈에서 `Message`, `TestSample` 등 핵심 도메인 모델을 각각 중복 정의하고 있어, 모듈 간 연동 시 타입 불일치와 유지보수 부담이 발생함.
- Proposed improvement: `src/chatbot_tester/common/models.py`를 신설하여 핵심 모델을 중앙화하고, 각 모듈이 이를 임포트하여 사용하도록 리팩토링함.
- Why this matters for an SDK: 프레임워크 전체에서 통용되는 "공통 언어(Ubiquitous Language)"를 코드로 확립하여 안정성과 확장성을 확보함.

### Idea 2
- Affected layer: Generator
- Current limitation: `pipeline.py`의 데이터 처리 과정(로드 → 정규화 → 필터링 → 샘플링)이 함수 호출로 하드코딩되어 있어, 데이터 증강(Augmentation)이나 사용자 정의 전처리를 끼워 넣기 어려움.
- Proposed improvement: `Chain of Responsibility` 패턴을 적용하여 변환 단계(Transform Step)를 리스트로 구성하고 순차 실행하는 유연한 파이프라인 구조로 변경함.
- Why this matters for an SDK: 사용자가 자신의 비즈니스 로직에 맞는 데이터 가공 단계를 플러그인 형태로 손쉽게 추가할 수 있어야 함.

### Idea 3
- Affected layer: Evaluator
- Current limitation: 평가 리포트 생성 시 `tag`, `language`, `length` 등 미리 정의된 차원으로만 점수를 분석(Breakdown)할 수 있어, 도메인 특화 메타데이터 분석이 제한적임.
- Proposed improvement: `Extractor` 인터페이스를 도입하여, `TestSample`의 메타데이터나 `RunResult`에서 분석 차원을 동적으로 추출할 수 있도록 개선함.
- Why this matters for an SDK: 다양한 도메인(커머스, 금융 등)의 사용자가 자신에게 의미 있는 기준(예: 상품 카테고리별 정확도)으로 모델을 평가할 수 있게 됨.

### Idea 4
- Affected layer: Common / IO
- Current limitation: 데이터셋 로딩과 결과 저장이 로컬 파일 시스템(`pathlib.Path`)에 강하게 결합되어 있어, S3나 GCS 같은 클라우드 스토리지 연동 시 코드 수정이 필요함.
- Proposed improvement: `ArtifactStore` 추상 클래스를 정의하고, 파일 입출력을 이 인터페이스로 감싸서 로컬 및 원격 저장소를 투명하게 지원함.
- Why this matters for an SDK: CI/CD 파이프라인이나 대규모 배치 실행 환경에서는 클라우드 스토리지 직접 연동이 필수적임.

### Idea 5
- Affected layer: CLI / Orchestration
- Current limitation: `gen-dataset`, `runner`, `evaluator`가 서로 다른 CLI 진입점을 가지고 있어, 전체 워크플로우를 실행하려면 별도의 쉘 스크립트가 필요하고 사용자 경험이 파편화됨.
- Proposed improvement: `ct` (또는 `chatbot-tester`)라는 단일 진입점 명령어를 제공하고, `ct gen`, `ct run` 등의 서브 커맨드로 기능을 통합함.
- Why this matters for an SDK: 통합된 CLI 환경을 제공하여 학습 곡선을 낮추고, 향후 파이프라인 오케스트레이션 기능의 기반을 마련함.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: 핵심 도메인 모델 중앙화 (Core Domain Models Centralization)
- Primary affected layer(s): Common

### Selection Rationale
- Architectural leverage: 모든 모듈(Generator, Runner, Evaluator)이 의존하는 최하위 데이터 구조를 통일함으로써 시스템 전반의 타입 안정성을 즉각적으로 향상시킴.
- Impact on extensibility / reuse: 향후 구현될 "통합 파이프라인"이나 "아티팩트 스토어"가 일관된 객체 모델 위에서 동작하도록 기반을 닦음.
- Reduction of future complexity: 코드 중복을 제거하여, 모델 변경 사항(예: 필드 추가)이 발생했을 때 한 곳만 수정하면 되도록 유지보수 비용을 낮춤.

### Deferred Ideas (Brief)
- Generator Pipeline: 구조적 개선이 필요하나, 현재의 하드코딩 방식도 기능적으로는 동작하므로 모델 통합 이후로 미룸.
- Dynamic Breakdowns: 평가 유연성을 위해 중요하지만, 데이터 모델이 안정화된 후 구현하는 것이 효율적임.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
**핵심 도메인 모델 중앙화 및 Common 모듈 신설**

### Problem Statement
- 현재 `runner/models.py`와 `generator/types.py`에 `Message`, `TestSample` 클래스가 중복 정의되어 있음.
- 형태는 유사하지만 서로 다른 클래스로 인식되므로, `Generator`가 생성한 객체를 `Runner`에 직접 전달하거나 타입 힌팅을 공유하기 어려움.
- 이는 프레임워크 내부의 결합도를 불필요하게 높이고, 라이브러리 사용자에게 혼동을 줌.

### Design Approach (High-level)
- Core concept: "Single Source of Truth" 원칙에 따라 데이터 모델을 한 곳(`common`)에서 관리함.
- Key abstractions or interfaces:
  - `src/chatbot_tester/common/models.py`: 공용 모델 정의 파일.
  - `Message`, `TestSample`: `dataclass(slots=True)`를 사용하여 메모리 효율성과 불변성을 지향하는 데이터 구조.
- Expected behavior:
  - `runner`와 `generator`는 더 이상 자체 모델을 정의하지 않고 `common`에서 임포트함.
  - 기존 코드는 `from .models import Message`와 같이 사용하고 있었으므로, 이를 `Re-export` 패턴으로 처리하여 하위 호환성을 유지함.

### MVP Scope
- Included in MVP:
  - `src/chatbot_tester/common/` 패키지 생성.
  - `Message`, `TestSample`, `DatasetInfo` 클래스 이관.
  - `runner/models.py` 및 `generator/types.py` 리팩토링 (Import 변경).
- Explicitly excluded:
  - `RunResult`, `EvaluationResult` 등 각 모듈에 특화된 모델은 이번 통합 대상에서 제외(각 모듈에 남겨둠).

### Optional / Future Extensions
- Pydantic 모델로의 전환 (직렬화/검증 강화).
- `protobuf` 등을 활용한 언어 중립적 스키마 정의.

### Acceptance Criteria
- [ ] `src/chatbot_tester/common/models.py` 파일이 생성되고 핵심 클래스가 정의됨.
- [ ] `generator`와 `runner`의 기존 유닛 테스트가 수정 없이(또는 최소한의 수정으로) 통과함.
- [ ] 순환 참조(Circular Import) 문제가 발생하지 않음.
- [ ] `slots=True`가 적용되어 대량의 객체 생성 시 메모리 효율이 고려됨.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Daily][2025-W06-day2] Centralize core domain models to common module`

### Task Breakdown
- [ ] Core implementation
  - Module: `src/chatbot_tester/common`
  - Summary: `models.py`를 생성하고 `Message`, `TestSample` 등 공용 데이터클래스 정의.
- [ ] Refactoring
  - `src/chatbot_tester/runner/models.py`: 클래스 정의를 삭제하고 `common.models`에서 임포트. `RunResult` 등은 유지.
  - `src/chatbot_tester/generator/types.py`: 클래스 정의를 삭제하고 `common.models`에서 임포트.
- [ ] API impact
  - Breaking change: No (내부 구현 변경, 외부 API는 Re-export로 유지).
  - Migration needed: No.
- [ ] Tests
  - Unit / Integration: 기존 테스트 수트 실행 및 통과 확인.
- [ ] Documentation
  - Docstrings: 공용 모델에 대한 명확한 Docstring 작성.

### Notes
- Backward compatibility concerns: `runner.models.Message`를 임포트해서 쓰던 외부 코드가 깨지지 않도록 `runner/models.py`에서 `from ..common.models import Message` 구문을 반드시 포함해야 함.
- Refactoring risk: 낮음. 단순 이동 및 임포트 변경.

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: 없음 (내부 리팩토링).
- 전달하고자 하는 핵심 메시지: N/A.

### Example Snippet (Optional)

```python
# src/chatbot_tester/common/models.py

from dataclasses import dataclass, field
from typing import Optional, Dict, Any, List

@dataclass(slots=True)
class Message:
    role: str
    content: str
    # ...
```
