# Daily Framework Planning – 2025-W06-day2

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common / Generator / Runner
- Current limitation: `Message` 및 `TestSample`과 같은 핵심 데이터 모델이 `generator`와 `runner` 패키지에 각각 중복 정의되어 있어, 모델 변경 시 양쪽을 동기화해야 하는 유지보수 비용이 발생함.
- Proposed improvement: `chatbot_tester.common.models` 모듈을 신설하여 핵심 모델을 중앙화하고, 각 모듈이 이를 참조하도록 리팩토링함.
- Why this matters for an SDK: 데이터 구조의 일관성(Consistency)을 보장하고, 모듈 간 상호운용성을 높임.

### Idea 2
- Affected layer: Evaluator / Runner
- Current limitation: `Evaluator`의 `ActiveLLMJudgeMetric`이 평가를 위해 `OpenAI` 클라이언트를 직접 인스턴스화하고 있어, `Runner`에 정의된 `ChatBackend` 추상화와 설정을 재사용하지 못함. 이로 인해 평가 단계에서 로컬 모델이나 다른 LLM을 사용하기 어려움.
- Proposed improvement: `ChatBackend` 및 `BackendRegistry`를 `chatbot_tester.common.backends`로 이동하여 `Generator`, `Runner`, `Evaluator`가 모두 동일한 백엔드 인터페이스를 사용할 수 있도록 함.
- Why this matters for an SDK: 평가 모델(Judge)의 유연한 교체를 지원하고, 외부 의존성 관리 코드를 한 곳에 집중시켜 확장성을 확보함.

### Idea 3
- Affected layer: Generator
- Current limitation: 데이터 생성 파이프라인(`load`, `canonicalize`, `filter` 등)이 `pipeline.py` 내에 함수 호출로 하드코딩되어 있어, 사용자가 커스텀 전처리나 필터링 로직을 주입하기 어려움.
- Proposed improvement: Chain of Responsibility 패턴 등을 활용하여 `PipelineStep` 인터페이스를 정의하고, 설정(Config)을 통해 파이프라인 단계를 동적으로 구성할 수 있도록 개선함.
- Why this matters for an SDK: 사용자가 자신의 도메인 특화 데이터 처리를 플러그인 형태로 쉽게 확장할 수 있게 함.

### Idea 4
- Affected layer: All (Configuration)
- Current limitation: `Generator`는 `PipelineOptions`, `Runner`는 `RunConfig`, `Evaluator`는 별도의 딕셔너리 설정을 사용하는 등 설정 관리 방식이 파편화되어 있음.
- Proposed improvement: `Unified Experiment Profile` (YAML)을 도입하여 데이터 생성부터 실행, 평가까지의 전체 라이프사이클을 하나의 설정 파일로 정의할 수 있도록 구조화함.
- Why this matters for an SDK: 사용자 경험(UX)을 통일하고, 실험의 재현성(Reproducibility)을 보장함.

### Idea 5
- Affected layer: Runner / Storage
- Current limitation: 실행 결과 저장이 로컬 파일시스템에 직접 의존(`write_run_results`)하고 있어, S3나 GCS 같은 원격 저장소 연동 시 코드를 수정해야 함.
- Proposed improvement: `ArtifactStore` 추상 클래스를 도입하여 파일 저장 로직을 캡슐화하고, 스토리지 백엔드를 교체 가능하도록 설계함.
- Why this matters for an SDK: 클라우드 환경이나 대규모 실험 환경에서의 운용성을 높임.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: **Backend Registry 및 Core Model 중앙화** (Centralization of Backend Registry & Core Models)
- Primary affected layer(s): Common, Runner, Evaluator

### Selection Rationale
- Architectural leverage: LLM 호출 로직을 `common`으로 이동시킴으로써 `Evaluator`가 `Runner`의 강력한 기능을 즉시 활용할 수 있게 되며, 이는 "평가 자동화"라는 핵심 가치를 강화함.
- Impact on extensibility / reuse: 향후 다양한 LLM(Claude, Ollama 등) 지원 추가 시 한 곳만 수정하면 되므로 확장성이 비약적으로 향상됨.
- Reduction of future complexity: 중복 코드를 제거하여 버그 발생 가능성을 낮추고 코드베이스를 경량화함.

### Deferred Ideas (Brief)
- Idea 3 (Modular Pipeline): 현재 생성 파이프라인이 단순하여 우선순위가 낮음.
- Idea 4 (Unified Config): 모델 및 백엔드 구조가 안정화된 후 적용하는 것이 효율적임.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
**Shared ChatBackend & Core Models in Common Package**

### Problem Statement
- 현재 어떤 점이 어렵거나, 불명확하거나, 오류를 유발하는가?
  - `Evaluator`가 `OpenAI` 외의 다른 모델을 Judge로 사용하려면 별도의 구현이 필요함.
  - `Message` 클래스가 중복되어 한쪽만 수정될 경우 런타임 에러 위험이 있음.
- 누구에게 영향을 주는가? (라이브러리 사용자 / CLI 사용자 / 프레임워크 유지보수자)
  - 프레임워크 유지보수자: 중복 코드 관리 부담.
  - 라이브러리 사용자: 커스텀 LLM을 평가에 사용하고 싶은 사용자.

### Design Approach (High-level)
- Core concept: `common` 패키지를 신설하여 "모두가 사용하는" 데이터 모델과 백엔드 로직을 격리 및 공유함.
- Key abstractions or interfaces:
  - `chatbot_tester.common.models.Message`
  - `chatbot_tester.common.models.TestSample`
  - `chatbot_tester.common.backends.ChatBackend`
  - `chatbot_tester.common.backends.BackendRegistry`
- Expected behavior:
  - `runner`와 `evaluator`는 `common`에서 백엔드를 import하여 사용.
  - 기존 코드의 동작 변경 없이 내부 구조만 개선(Refactoring).

### MVP Scope
- Included in MVP:
  - `common` 패키지 생성 및 `models`, `backends` 모듈 구현.
  - `runner`의 `models.py`, `backends/` 로직 이관 및 import 경로 수정.
  - `generator`의 `types.py`가 `common.models`를 사용하도록 수정.
- Explicitly excluded:
  - `Evaluator` 코드의 전면적인 리팩토링 (이는 후속 작업으로 진행).
  - 새로운 백엔드 추가.

### Optional / Future Extensions
- `Evaluator`의 `ActiveLLMJudgeMetric`이 `BackendRegistry`를 통해 클라이언트를 주입받도록 수정.
- `common`에 로깅 및 에러 처리 유틸리티 추가.

### Acceptance Criteria
- [ ] `chatbot_tester.common` 패키지가 존재하고 핵심 클래스들이 포함됨.
- [ ] `pytest` 실행 시 기존 테스트(`tests/`)가 모두 통과함.
- [ ] `generator`와 `runner`가 상호 참조 없이 `common`을 통해 데이터 구조를 공유함.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Refactor] Extract 'common' package for Models and Backends`

### Task Breakdown
- [ ] Core implementation
  - Module: `chatbot_tester.common`
  - Summary: `models.py`에 `Message`, `TestSample` 정의. `backends/`에 `ChatBackend`, `BackendRegistry` 이동.
- [ ] Code Refactoring
  - Update `runner/models.py`: `common.models` 상속 또는 위임.
  - Update `runner/backends/`: `common.backends` 사용하도록 수정.
  - Update `generator/types.py`: `common.models` 사용.
- [ ] Tests
  - Unit / Integration: 기존 `runner` 및 `generator` 테스트가 깨지지 않음을 확인.
- [ ] Documentation
  - README / Examples / Docstrings: 변경된 모듈 경로 반영 (필요 시).

### Notes
- Backward compatibility concerns: 내부 API 경로가 변경되므로 `runner.models` 등에서 `common.models`를 re-export하여 하위 호환성을 최대한 유지해야 함.
- Refactoring risk: 순환 참조(Circular Dependency) 발생 주의 (`common`은 다른 모듈을 import하지 않아야 함).

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: Architecture Overview
- 전달하고자 하는 핵심 메시지: 이제 `common` 패키지를 통해 데이터 모델과 백엔드 시스템이 중앙화되었음.

### Example Snippet (Optional)

```python
# Before
from chatbot_tester.runner.models import Message
from chatbot_tester.generator.types import Message as GenMessage

# After
from chatbot_tester.common.models import Message
```
