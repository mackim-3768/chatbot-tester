# Daily Framework Planning – 2025-W06-day2

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common / Generator / Runner
- Current limitation: `Message`와 `TestSample` 같은 핵심 도메인 모델이 `generator.types`와 `runner.models`에 중복 정의되어 있습니다. `Runner` 버전은 `slots=True`와 `from_dict`를 지원하는 반면, `Generator` 버전은 그렇지 않아 일관성이 부족합니다.
- Proposed improvement: `chatbot_tester.common` 패키지를 신설하고 도메인 모델을 중앙화하여 모든 모듈이 이를 참조하도록 리팩토링합니다.
- Why this matters for an SDK: 데이터 구조의 단일 진실 공급원(SSOT)을 확보하여 모듈 간 통합 시 발생할 수 있는 호환성 문제를 방지하고 유지보수 비용을 절감합니다.

### Idea 2
- Affected layer: Runner
- Current limitation: 백엔드 클라이언트(예: OpenAI) 인스턴스화 로직이 여러 곳에 분산되어 있거나(`EmbeddingSimilarityMetric` 등), 중앙 레지스트리의 활용이 강제되지 않습니다.
- Proposed improvement: 모든 LLM 호출을 처리하는 `ChatBackend` 레지스트리를 강화하고, 직접 인스턴스 생성을 막는 팩토리 패턴을 엄격히 적용합니다.
- Why this matters for an SDK: 테스트 환경 구성 시 모킹(Mocking)과 설정 관리의 일관성을 높이고, 새로운 백엔드 추가를 쉽게 만듭니다.

### Idea 3
- Affected layer: Common
- Current limitation: 로그, 지표, 실행 상태 추적이 각 모듈(`runner`, `evaluator`)에서 개별적으로 이루어져 전체 파이프라인의 관측(Observability)이 어렵습니다.
- Proposed improvement: `EventBus` 시스템을 도입하여 파이프라인 전반의 이벤트를 중앙에서 구독하고 처리할 수 있게 합니다.
- Why this matters for an SDK: 사용자가 커스텀 로깅이나 모니터링 시스템을 쉽게 연동할 수 있는 확장 포인트를 제공합니다.

### Idea 4
- Affected layer: Evaluator
- Current limitation: 평가 리포트가 정적인 HTML/JSON으로만 생성되며, 실행 중에 실시간으로 진행 상황을 파악하기 어렵습니다.
- Proposed improvement: 스트리밍 가능한 리포터 인터페이스를 추가하여 실행 진행률과 중간 결과를 실시간으로 출력하거나 웹소켓으로 전송할 수 있게 합니다.
- Why this matters for an SDK: 긴 실행 시간이 소요되는 대규모 평가 작업에서 사용자 경험(UX)을 크게 향상시킵니다.

### Idea 5
- Affected layer: CLI
- Current limitation: `chatbot-tester`의 진입점이 명확하지 않고 모듈별로 산재되어 있어(`generator/cli.py`, `runner/cli.py` 등), 사용자가 도구를 통합적으로 사용하기 어렵습니다.
- Proposed improvement: 통합 CLI (`ct`)를 구축하여 `ct gen`, `ct run`, `ct eval`과 같이 하위 명령어로 기능을 체계화합니다.
- Why this matters for an SDK: 개발자 도구로서의 사용성을 높이고 학습 곡선을 낮춥니다.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: `common` 패키지 신설 및 도메인 모델 중앙화
- Primary affected layer(s): Common, Generator, Runner

### Selection Rationale
- Architectural leverage: 가장 기초적인 데이터 구조를 정리함으로써 이후의 통합 작업(파이프라인 구축, 이벤트 버스 등)의 기반을 마련합니다.
- Impact on extensibility / reuse: 모델 정의가 한 곳에 있으면 새로운 모듈(예: Orchestrator) 추가 시 재사용이 용이합니다.
- Reduction of future complexity: 코드 중복으로 인한 버그(한쪽만 수정되는 경우)를 원천 차단합니다.

### Deferred Ideas (Brief)
- Idea 2 (Backend Registry): `runner` 내부 리팩토링으로 진행 가능하며, 구조적 변경보다는 구현 상세에 가깝습니다.
- Idea 3 (EventBus): 모델 통합이 선행되어야 이벤트 페이로드 정의가 수월해집니다.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
공통 도메인 모델 패키지 (`chatbot_tester.common`)

### Problem Statement
- 현재 `Message`와 `TestSample` 클래스가 `generator`와 `runner` 패키지에 각각 정의되어 있어 코드 중복이 발생하고 있습니다.
- `Runner`의 모델은 `slots=True` 최적화와 직렬화 메서드를 포함하지만, `Generator` 모델은 단순 데이터 클래스로 남아있어 기능 차이가 존재합니다.
- 이는 라이브러리 유지보수자에게 중복 수정의 부담을 주며, 추후 두 모듈을 연결할 때 호환성 문제를 일으킬 수 있습니다.

### Design Approach (High-level)
- Core concept: `src/chatbot_tester/common` 패키지를 생성하고 공유 모델을 이곳으로 이동시킵니다.
- Key abstractions or interfaces:
  - `chatbot_tester.common.models.Message`
  - `chatbot_tester.common.models.TestSample`
- Expected behavior:
  - `generator`와 `runner`는 더 이상 자체적으로 모델을 정의하지 않고 `common`에서 임포트하여 사용합니다.
  - `Runner`의 더 강력한 모델 구현(`from_dict`, `to_dict`, `slots`)을 표준으로 채택합니다.

### MVP Scope
- Included in MVP:
  - `src/chatbot_tester/common` 디렉토리 및 `__init__.py` 생성.
  - `Message`, `TestSample` 클래스 이동 (Runner 버전 기준).
  - `generator/types.py` 및 `runner/models.py`에서 해당 클래스 제거 후 임포트로 대체.
- Explicitly excluded:
  - `Evaluator`의 `TestSampleRecord` 통합 (추후 별도 진행).
  - `RunResult` 등 `Runner` 전용 모델의 이동.

### Optional / Future Extensions
- `pydantic` 모델로의 전환 (유효성 검사 강화).
- `Evaluator` 도메인 모델과의 통합.

### Acceptance Criteria
- [ ] `chatbot_tester.common.models` 모듈이 존재해야 함.
- [ ] `Message`와 `TestSample`이 `common`에 정의되어 있어야 함.
- [ ] `generator`와 `runner`의 기존 테스트가 수정 없이(또는 임포트 수정만으로) 통과해야 함.
- [ ] `slots=True` 속성이 유지되어 메모리 효율성이 확보되어야 함.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Refactor][Common] Establish common package and centralize domain models`

### Task Breakdown
- [ ] Core implementation
  - Module: `chatbot_tester.common`
  - Summary: `Message`, `TestSample` 클래스를 `runner/models.py`에서 `common/models.py`로 이동.
- [ ] CLI changes (if any)
  - Command: N/A
  - Flags / options: N/A
- [ ] API impact
  - Breaking change: No (내부 패키지 구조 변경이나, 공개 API로서 `generator.types` 등을 통해 노출된 경우 임포트로 호환성 유지).
  - Migration needed: No (사용자 관점에서는 동일하게 동작).
- [ ] Tests
  - Unit / Integration: 기존 `tests/generator` 및 `tests/runner`(존재 시) 실행하여 회귀 검증.
- [ ] Documentation
  - README / Examples / Docstrings: 개발자 가이드에 공통 패키지 구조 언급.

### Notes
- Backward compatibility concerns: `generator.types.Message`를 임포트해서 쓰던 외부 코드가 있다면, `generator/types.py`에서 `from ..common.models import Message` 구문으로 호환성을 유지해야 합니다.
- Refactoring risk: 낮음 (단순 이동 및 임포트 변경).

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: Architecture Overview (있는 경우)
- 전달하고자 하는 핵심 메시지: "핵심 도메인 모델은 `common` 패키지에서 관리됩니다."

### Example Snippet (Optional)

```python
# 내부 개발자용 예시
from chatbot_tester.common.models import Message, TestSample

msg = Message(role="user", content="Hello")
sample = TestSample(id="1", messages=[msg])
```
