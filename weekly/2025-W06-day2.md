# Daily Framework Planning – 2025-W06-day2

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common / All
- Current limitation: `generator`, `runner`, `evaluator` 모듈에서 `Message`, `TestSample` 등의 핵심 데이터 모델이 중복 정의되어 있어, 변경 시 불일치 위험이 있고 모듈 간 연동이 매끄럽지 않음.
- Proposed improvement: `src/chatbot_tester/common` 패키지를 신설하고 `Message`, `TestSample`, `DatasetInfo` 등 공통 모델을 일원화하여 모든 모듈이 이를 참조하도록 변경.
- Why this matters for an SDK: 데이터 구조의 일관성(Consistency)은 SDK 사용자가 여러 모듈을 조합해 사용할 때 필수적인 요소이며, 유지보수 복잡도를 낮춤.

### Idea 2
- Affected layer: Generator / Runner / Evaluator
- Current limitation: 데이터 생성, 실행, 평가 설정이 각각 분리되어 있어, 하나의 실험(Experiment)을 재현하기 위해서는 여러 CLI 명령과 설정 파일을 조합해야 함.
- Proposed improvement: `experiment.yaml` 단일 설정 파일을 도입하여 전체 파이프라인(Generate -> Run -> Evaluate)을 선언적으로 관리하는 'Unified Experiment Profile' 구현.
- Why this matters for an SDK: 실험의 재현성(Reproducibility)을 보장하고, 사용자 경험(UX)을 통합하여 복잡한 테스트 시나리오를 쉽게 관리하게 함.

### Idea 3
- Affected layer: Generator
- Current limitation: `pipeline.py` 내의 데이터 변환 로직(Load -> Canonicalize -> Filter -> Sample)이 하드코딩되어 있어, 사용자 정의 전처리나 데이터 증강 단계를 추가하기 어려움.
- Proposed improvement: Chain of Responsibility 패턴을 적용하여 변환 단계를 동적으로 구성하고 확장할 수 있는 파이프라인 구조로 개선.
- Why this matters for an SDK: 다양한 원천 데이터와 전처리 요구사항을 수용할 수 있는 확장성(Extensibility)을 제공함.

### Idea 4
- Affected layer: Runner
- Current limitation: 결과 저장이 로컬 파일 시스템(`pathlib`)에 직접 의존하고 있어, 대규모 실행이나 클라우드 환경(S3, GCS)에서의 사용이 제한적임.
- Proposed improvement: `ArtifactStore` 추상 계층을 도입하여 저장소 백엔드를 플러그인 형태로 교체 가능하도록 설계.
- Why this matters for an SDK: 로컬 개발 환경과 클라우드 운영 환경 간의 이식성(Portability)을 높임.

### Idea 5
- Affected layer: Runner / Evaluator
- Current limitation: 로깅과 진행 상태 보고 로직이 비즈니스 로직과 강하게 결합되어 있어, 커스텀 리포터나 모니터링 시스템 연동이 어려움.
- Proposed improvement: Event Bus 패턴을 도입하여 실행 상태, 지표, 로그 이벤트를 발행하고 이를 구독하여 처리하도록 분리.
- Why this matters for an SDK: 모니터링 및 리포팅 기능의 확장을 용이하게 하고(Observability), 핵심 로직의 결합도를 낮춤.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: Core Model Centralization (Shared Common Package)
- Primary affected layer(s): Common, Generator, Runner, Evaluator

### Selection Rationale
- Architectural leverage: 모든 모듈(Generator, Runner, Evaluator)이 공유하는 기반 데이터 구조이므로, 이를 정리하지 않으면 상위 레벨의 통합(예: Unified Experiment Profile)이나 파이프라인 개선이 불가능함. 가장 기초가 되는 'Protocol'을 정의하는 작업임.
- Impact on extensibility / reuse: 코드 중복을 제거하고 타입 안전성을 보장하여, 향후 기능 추가 시 모델 변경 비용을 최소화함.
- Reduction of future complexity: 각 모듈이 서로 다른 모델 정의를 가질 때 발생하는 변환 로직의 난립을 방지함.

### Deferred Ideas (Brief)
- Idea 2 (Unified Experiment): 모델 중앙화가 선행되어야 설정 파일 구조도 명확해지므로 연기.
- Idea 3 (Generator Pipeline): Generator 내부의 개선 사항이므로, 전체 아키텍처에 영향을 주는 모델 중앙화보다 우선순위가 낮음.
- Idea 4, 5: 기능적 개선 사항으로, 구조적 기초 공사 이후에 진행하는 것이 효율적임.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
**Core Model Centralization (Shared Common Package)**

### Problem Statement
- 현재 `Message`, `TestSample` 클래스가 `generator.types`, `runner.models`, `evaluator.domain` 등 여러 곳에 중복 정의되어 있음.
- 속성 추가나 변경 시 모든 파일을 수정해야 하며, 실수로 인한 불일치가 런타임 오류나 데이터 유실을 유발할 수 있음.
- 라이브러리 사용자 입장에서는 모듈 간 데이터를 전달할 때 호환성 여부를 확신하기 어려움.

### Design Approach (High-level)
- Core concept: 'Single Source of Truth' 원칙을 적용하여 데이터 모델 정의를 한 곳으로 모음.
- Key abstractions or interfaces:
  - `src/chatbot_tester/common` 패키지 신설.
  - `common.models` 모듈에 `Message`, `TestSample`, `DatasetInfo` 정의.
  - Pydantic 또는 `dataclasses(slots=True)`를 사용하여 엄격한 타입 정의 및 `to_dict`/`from_dict` 직렬화 지원.
- Expected behavior:
  - Generator는 `common.models.TestSample` 객체를 생성하여 반환.
  - Runner는 `common.models.TestSample`을 입력받아 실행하고 `common.models.RunResult`(또는 관련 모델)를 반환.
  - Evaluator는 이들을 입력받아 평가 수행.

### MVP Scope
- Included in MVP:
  - `src/chatbot_tester/common` 패키지 생성.
  - `Message`, `TestSample`, `DatasetInfo` 모델 이동 및 통합.
  - `generator`, `runner` 모듈에서 기존 모델 정의 제거 및 `common` 참조로 리팩토링.
- Explicitly excluded:
  - `RunResult` (Runner 특화), `EvalScore` (Evaluator 특화) 등 특정 도메인에 종속적인 모델은 이번 단계에서 제외할 수 있으나, 가능하면 `RunResult`의 공통 부분도 고려. (일단 MVP는 입력 데이터 모델 중심)

### Optional / Future Extensions
- Pydantic `BaseModel` 도입을 통한 런타임 유효성 검사 강화.
- `RunResult`, `EvalScore` 등 출력 모델까지 중앙화 확대.

### Acceptance Criteria
- [ ] `src/chatbot_tester/common/models.py`가 존재하고 핵심 모델이 정의됨.
- [ ] `generator`, `runner` 모듈이 로컬 정의 없이 `common.models`를 import하여 정상 동작함.
- [ ] 기존 테스트(`tests/`)가 수정 없이(또는 import 경로 수정만으로) 통과함.
- [ ] 순환 참조(Circular Import) 문제가 발생하지 않음.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Daily][2025-W06-day2] Core Model 중앙화 및 패키지 구조 개선`

### Task Breakdown
- [ ] Core implementation
  - Module: `chatbot_tester.common`
  - Summary: `common` 패키지 생성, `__init__.py` 및 `models.py` 작성 (`Message`, `TestSample` 이동).
- [ ] Refactoring (Generator)
  - Module: `chatbot_tester.generator`
  - Summary: `types.py` 내 모델 정의 삭제, `common.models` import로 변경, 관련 코드 수정.
- [ ] Refactoring (Runner)
  - Module: `chatbot_tester.runner`
  - Summary: `models.py` 내 `Message`, `TestSample` 정의 삭제, `common.models` import로 변경.
- [ ] API impact
  - Breaking change: Yes (내부적으로 모델 위치 변경, 공개 API가 모델 객체를 노출한다면 영향 있음)
  - Migration needed: Yes (사용자 코드가 `generator.types.Message`를 직접 import했다면 수정 필요)
- [ ] Tests
  - Unit / Integration: 기존 테스트 수행하여 호환성 검증, 직렬화/역직렬화 테스트 케이스 추가.
- [ ] Documentation
  - README / Examples: 모델 import 경로 변경 사항 반영.

### Notes
- Backward compatibility concerns: `generator.types`나 `runner.models`에서 `common.models`의 클래스를 re-export하여 하위 호환성을 유지하는 전략을 고려할 것. (예: `from ..common.models import Message`)
- Refactoring risk: `evaluator` 모듈까지 한 번에 수정하면 변경 범위가 너무 커질 수 있으므로, Generator/Runner 먼저 적용 후 Evaluator로 확대하는 단계적 접근 권장.

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: 'Architecture' 또는 'Developer Guide'
- 전달하고자 하는 핵심 메시지: "모든 핵심 데이터 모델은 `chatbot_tester.common`에 정의되어 있으며, 각 모듈은 이를 공유합니다."

### Example Snippet (Optional)

```python
# Before
from chatbot_tester.generator.types import Message
from chatbot_tester.runner.models import Message as RunnerMessage

# After
from chatbot_tester.common.models import Message

msg = Message(role="user", content="Hello")
# Generator와 Runner 모두 동일한 msg 객체를 이해함
```
