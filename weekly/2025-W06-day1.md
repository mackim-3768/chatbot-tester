# Daily Framework Planning – 2025-W06-day1

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common
- Current limitation: `runner` 모듈의 `models.py`와 `generator` 모듈의 `types.py`에 `Message`, `TestSample` 등의 핵심 데이터 모델이 중복 정의되어 있습니다.
- Proposed improvement: `src/chatbot_tester/common/models.py`를 신설하여 공통 모델을 단일 진실 공급원(Single Source of Truth)으로 관리하고, 각 모듈이 이를 참조하도록 리팩토링합니다.
- Why this matters for an SDK: 데이터 구조의 일관성을 보장하고, 모듈 간 상호운용성(Interoperability)을 높여 사용자가 혼란 없이 SDK를 활용할 수 있게 합니다.

### Idea 2
- Affected layer: Common, Runner, Evaluator
- Current limitation: `runner`는 자체적인 `BackendRegistry`를 통해 LLM을 호출하지만, `evaluator`의 `EmbeddingSimilarityMetric` 등은 `OpenAI` 클라이언트를 직접 인스턴스화하여 사용합니다. 이는 설정 관리의 파편화를 초래합니다.
- Proposed improvement: `ChatBackend` 인터페이스와 `BackendRegistry`를 `src/chatbot_tester/common/backends`로 이동하여 통합하고, 모든 모듈이 이를 통해 LLM 리소스에 접근하도록 합니다.
- Why this matters for an SDK: LLM 호출 방식과 설정을 중앙화하여, 새로운 모델이나 백엔드 추가 시 프레임워크 전체에 일관되게 적용되도록 합니다.

### Idea 3
- Affected layer: CLI
- Current limitation: `generator`, `runner`, `evaluator`가 각각 개별적인 CLI 진입점을 가지고 있어(`python -m chatbot_tester.generator.cli` 등), 사용자 경험이 분절적입니다.
- Proposed improvement: `ct` (가칭)와 같은 통합 CLI 커맨드를 제공하여 서브커맨드(`ct gen`, `ct run` 등) 방식으로 기능을 노출합니다.
- Why this matters for an SDK: 직관적인 사용자 인터페이스를 제공하여 학습 곡선을 낮추고 사용성을 개선합니다.

### Idea 4
- Affected layer: Evaluator
- Current limitation: 평가 지표(Metric) 실행 시 메타데이터(예: 태그, 난이도 등)를 기반으로 점수를 세분화(breakdown)하여 분석하는 기능이 부족하거나 하드코딩되어 있을 수 있습니다.
- Proposed improvement: 사용자가 설정 파일을 통해 데이터 차원(dimension)을 정의하고, 이에 따라 평가 결과를 자동으로 그룹화하여 집계하는 동적 분석 기능을 추가합니다.
- Why this matters for an SDK: 단순 평균 점수 외에 데이터 특성에 따른 모델 성능의 편향을 분석할 수 있는 심층적인 도구를 제공합니다.

### Idea 5
- Affected layer: Common / Infrastructure
- Current limitation: 데이터셋 로딩 및 결과 저장이 로컬 파일 시스템(`pathlib`)에 의존적으로 구현되어 있어, 클라우드 환경(S3 등) 확장이 어렵습니다.
- Proposed improvement: `ArtifactStore` 추상화 계층을 도입하여 로컬, S3, GCS 등 다양한 스토리지 백엔드를 지원하도록 합니다.
- Why this matters for an SDK: 엔터프라이즈 환경이나 대규모 실험 환경에서도 유연하게 프레임워크를 연동할 수 있는 확장성을 제공합니다.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: `chatbot_tester.common` 패키지 신설 및 Backend/Model 통합
- Primary affected layer(s): Common, Runner, Generator, Evaluator

### Selection Rationale
- Architectural leverage: 프레임워크의 가장 기초가 되는 데이터 모델과 LLM 연동 계층을 통합함으로써, 상위 모듈(`generator`, `runner`, `evaluator`) 간의 결합도를 낮추고 응집도를 높일 수 있습니다.
- Impact on extensibility / reuse: 공통 백엔드 레지스트리를 통해 `evaluator`에서도 쉽게 다양한 LLM을 Judge 모델로 활용할 수 있게 되어 확장성이 대폭 향상됩니다.
- Reduction of future complexity: 현재 존재하는 코드 중복(`types.py` vs `models.py`)과 파편화된 LLM 호출 로직을 조기에 해결하지 않으면 기술 부채가 기하급수적으로 증가할 위험이 있습니다.

### Deferred Ideas (Brief)
- Idea 3 (Unified CLI): 핵심 아키텍처 정비가 선행된 후 사용자 인터페이스를 개선하는 것이 순서상 적절함.
- Idea 4 (Dynamic Evaluation): 현재 평가 로직이 안정화된 후 분석 기능을 고도화하는 단계에서 진행 예정.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
Unified Common Core (`chatbot_tester.common`) & Backend Registry

### Problem Statement
- 현재 `runner` 모듈에 정의된 `Message`, `TestSample` 등의 모델이 `generator` 모듈에 중복 정의되어 있어 유지보수가 어렵습니다.
- `evaluator` 모듈의 일부 Metric 구현체(`EmbeddingSimilarityMetric`)가 `OpenAI` 라이브러리를 직접 사용하고 있어, `runner`에서 설정한 백엔드 구성(재시도 정책, 타임아웃 등)을 공유받지 못합니다.
- 이로 인해 라이브러리 사용자 및 프레임워크 유지보수자는 동일한 기능을 여러 번 구현하거나 설정을 중복 관리해야 하는 부담이 있습니다.

### Design Approach (High-level)
- Core concept: "Shared Nothing"이 아닌 "Common Core" 패턴을 적용하여, 상태를 가지지 않는 데이터 모델과 핵심 인터페이스를 별도 패키지로 분리합니다.
- Key abstractions or interfaces:
  - `src/chatbot_tester/common/models.py`: `Message`, `TestSample`, `RunConfig` 등 Pydantic/Dataclass 모델 정의.
  - `src/chatbot_tester/common/backends/base.py`: `ChatBackend` 추상 클래스 및 `BackendRegistry`.
- Expected behavior:
  - `generator`는 `common.models`를 사용하여 데이터셋을 생성합니다.
  - `runner`는 `common.backends`를 통해 추론을 수행합니다.
  - `evaluator`는 `common.backends`를 통해 Judge LLM을 호출합니다.

### MVP Scope
- Included in MVP:
  - `src/chatbot_tester/common` 패키지 구조 생성
  - `runner.models`의 내용을 `common.models`로 이동 및 `generator.types` 제거
  - `runner.backends`의 내용을 `common.backends`로 이동
  - 기존 모듈(`runner`, `generator`, `evaluator`)의 import 경로 수정
- Explicitly excluded:
  - CLI 통합 (별도 태스크로 진행)
  - 새로운 백엔드 구현 (기존 OpenAI 등 유지)

### Optional / Future Extensions
- `common` 패키지를 별도 라이브러리(`chatbot-tester-core`)로 분리하여 배포.
- 백엔드 설정 포맷(YAML/JSON)의 표준화 및 검증 로직 추가.

### Acceptance Criteria
- [ ] `src/chatbot_tester/common` 패키지가 생성되고 `models.py`, `backends/`가 존재해야 함.
- [ ] `src/chatbot_tester/runner/models.py`와 `src/chatbot_tester/generator/types.py`가 제거되거나 `common`을 re-export 하도록 변경됨.
- [ ] `evaluator`의 `EmbeddingSimilarityMetric`이 `common.backends.BackendRegistry`를 통해 클라이언트를 획득하도록 수정됨 (또는 그 기반이 마련됨).
- [ ] 기존 테스트(`pytest`)가 import 에러 없이 통과해야 함.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Daily][2025-W06-day1] Common 패키지 신설 및 모델/백엔드 통합 리팩토링`

### Task Breakdown
- [ ] Core implementation
  - Module: `chatbot_tester.common`
  - Summary: `models.py` 및 `backends` 패키지를 `runner`에서 `common`으로 이동하고 의존성 정리.
- [ ] CLI changes (if any)
  - Command: N/A
  - Flags / options: N/A
- [ ] API impact
  - Breaking change: Yes
  - Migration needed: Yes (Import 경로 변경 필요)
- [ ] Tests
  - Unit / Integration: 기존 `runner`, `generator` 유닛 테스트의 import 경로를 수정하여 정상 동작 확인.
- [ ] Documentation
  - README / Examples / Docstrings: 변경된 모듈 경로에 맞춰 개발 가이드 업데이트.

### Notes
- Backward compatibility concerns: 기존 사용자가 `from chatbot_tester.runner.models import Message`를 사용 중일 수 있으므로, 당분간 `runner.models`에서 `common.models`의 내용을 import하여 노출(re-export)하는 방식을 유지해야 함.
- Refactoring risk: 순환 참조(Circular Import) 문제가 발생할 수 있으므로, `common` 패키지는 다른 내부 패키지를 import하지 않도록 엄격히 제한해야 함.

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: "Architecture" 또는 "Developer Guide"
- 전달하고자 하는 핵심 메시지: "핵심 데이터 모델과 백엔드 인터페이스는 `chatbot_tester.common`에 위치하며, 모든 서브 모듈은 이를 공유합니다."

### Example Snippet (Optional)

```python
# Before (Runner)
from chatbot_tester.runner.models import Message
from chatbot_tester.runner.backends import BackendRegistry

# After (Unified)
from chatbot_tester.common.models import Message
from chatbot_tester.common.backends import BackendRegistry

# Evaluator accessing backend
registry = BackendRegistry()
backend = registry.create("openai", api_key="...")
response = await backend.send(request)
```
