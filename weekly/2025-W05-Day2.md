# Daily Framework Planning – 2025-W05-Day2

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: 공통 (Common)
- Current limitation: 파일 경로나 디렉터리 생성을 사용자가 직접 `os.path.join`이나 문자열로 관리해야 해서 오류가 잦고 구조가 파편화됨.
- Proposed improvement: `WorkspaceManager`를 도입하여 실험 디렉터리(`runs/`, `dataset/`)의 생성, 조회, 검증을 중앙에서 담당.
- Why this matters for an SDK: SDK 사용자가 파일 시스템 구조에 대해 고민하지 않고 논리적인 ID(예: `run_id`)만으로 리소스에 접근할 수 있게 됨.

### Idea 2
- Affected layer: 공통 (Common)
- Current limitation: 구성 파일(`pipeline.yaml`)을 로드하는 로직이 각 모듈에 분산되어 있거나 아직 표준화되지 않음.
- Proposed improvement: `ConfigLoader` 클래스를 만들어 YAML/JSON 파싱, 환경 변수 치환, 스키마 유효성 검사를 통합 처리.
- Why this matters for an SDK: 다양한 환경(로컬, CI)에서 일관된 설정 로딩 동작을 보장하고, 사용자 실수에 대해 친절한 에러 메시지를 제공할 수 있음.

### Idea 3
- Affected layer: Runner
- Current limitation: 파이프라인 실행 중 오류가 발생했을 때, 어떤 단계에서 실패했는지 명확히 알기 어렵고 로그가 산재됨.
- Proposed improvement: 구조화된 로깅(Structured Logging)과 에러 컨텍스트(Error Context) 래퍼를 도입하여 문제 추적성을 높임.
- Why this matters for an SDK: 디버깅 용이성은 SDK 채택의 핵심 요소임.

### Idea 4
- Affected layer: Generator / Runner
- Current limitation: 생성된 데이터셋이나 실행 결과에 대한 메타데이터(버전, 생성자, 설명 등) 관리가 부족함.
- Proposed improvement: 각 주요 아티팩트(dataset, run result) 저장 시 `metadata.json`을 의무적으로 함께 생성하도록 강제.
- Why this matters for an SDK: 실험 이력 관리와 추적성(Provenance)을 확보하여 신뢰할 수 있는 ML 파이프라인 구축 가능.

### Idea 5
- Affected layer: CLI
- Current limitation: 긴 작업(대규모 생성 또는 실행) 시 진행 상황을 알 수 없어 사용자가 불안해함.
- Proposed improvement: `tqdm` 등을 래핑한 `ProgressReporter` 인터페이스를 제공하여 CLI와 라이브러리 모드 모두에서 진행률 콜백을 받을 수 있게 함.
- Why this matters for an SDK: 사용자 경험(UX) 개선 및 장시간 실행되는 작업의 모니터링 가능.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: 워크스페이스 매니저 (Workspace Manager) 도입
- Primary affected layer(s): 공통 (Common)

### Selection Rationale
- Architectural leverage: 모든 컴포넌트(Generator, Runner, Evaluator)가 파일 시스템과 상호작용하므로, 이 부분을 먼저 추상화해야 향후 개발될 "통합 파이프라인"이 견고해짐.
- Impact on extensibility / reuse: 사용자가 임의의 경로를 하드코딩하는 것을 방지하고, SDK가 정의한 표준 디렉터리 레이아웃을 따르도록 유도함.
- Reduction of future complexity: 경로 조립(`os.path.join`) 로직을 한곳으로 모아 중복 코드를 제거하고 버그를 예방.

### Deferred Ideas (Brief)
- Idea 2 (ConfigLoader): Workspace가 정리된 후 구성 파일을 어디서 로드할지 결정하는 것이 순서상 자연스러움.
- Idea 5 (ProgressReporter): 기능적 개선이지만 구조적 기반(Workspace)이 더 시급함.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
워크스페이스 매니저 (Workspace Manager)

### Problem Statement
- 현재 어떤 점이 어렵거나, 불명확하거나, 오류를 유발하는가?
  - 코드 곳곳에 `os.makedirs("output", exist_ok=True)`와 같은 로직이 흩어져 있음.
  - 실행 ID(`run_id`) 기반으로 파일을 저장할 때 경로 규칙이 일관되지 않을 수 있음.
- 누구에게 영향을 주는가? (라이브러리 사용자 / CLI 사용자 / 프레임워크 유지보수자)
  - 유지보수자: 경로 변경 시 여러 파일을 수정해야 함.
  - 사용자: 결과 파일이 어디에 저장되는지 헷갈림.

### Design Approach (High-level)
- Core concept: `Workspace` 객체가 특정 루트 디렉터리(기본값 `./workspace`)를 관리하며, 하위의 `runs`, `data` 디렉터리에 대한 접근을 제어함.
- Key abstractions or interfaces:
  ```python
  class Workspace:
      def __init__(self, root: str | Path): ...
      def get_run_dir(self, run_id: str) -> Path: ...
      def create_run(self, run_id: str | None = None) -> Tuple[str, Path]: ...
      def get_dataset_dir(self, dataset_id: str) -> Path: ...
  ```
- Expected behavior:
  - `Workspace` 인스턴스 생성 시 루트 디렉터리가 자동 생성되지 않더라도, 하위 디렉터리 요청 시 안전하게 생성.
  - 유효하지 않은 ID(특수문자 등)에 대한 검증 수행.

### MVP Scope
- Included in MVP:
  - `src/chatbot_tester/common` 패키지 신설.
  - `Workspace` 클래스 구현.
  - `runs/{run_id}` 및 `datasets/{dataset_id}` 경로 해석 및 생성 메서드.
- Explicitly excluded:
  - 원격 스토리지(S3 등) 지원 (로컬 파일 시스템만 대상).
  - 파일 잠금(File locking) 메커니즘.

### Optional / Future Extensions
- 오래된 실행 결과 자동 정리(Clean-up) 정책.
- 아티팩트 압축/보관 기능.

### Acceptance Criteria
- [ ] `Workspace(root)`로 인스턴스를 생성할 수 있다.
- [ ] `create_run()` 호출 시 고유한 ID(또는 지정된 ID)로 디렉터리가 생성된다.
- [ ] `get_run_dir("non_existent")` 호출 시 디렉터리가 없으면 생성하거나(옵션) 경로를 반환한다.
- [ ] 특수문자가 포함된 ID 사용 시 예외를 발생시키거나 안전한 이름으로 변환한다.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Common] Implement Workspace Manager for path abstraction`

### Task Breakdown
- [ ] Core implementation
  - Module: `src/chatbot_tester/common/workspace.py`
  - Summary: `Workspace` 클래스 및 경로 관리 로직 구현.
- [ ] CLI changes (if any)
  - Command: N/A (이후 파이프라인 연동 시 `--workspace` 옵션으로 활용 예정)
  - Flags / options: N/A
- [ ] API impact
  - Breaking change: No (기존 코드는 아직 이 모듈을 사용하지 않음)
  - Migration needed: No (점진적 도입 가능)
- [ ] Tests
  - Unit / Integration: `tests/common/test_workspace.py`에서 디렉터리 생성 및 경로 반환 검증.
- [ ] Documentation
  - README / Examples / Docstrings: 클래스 및 메서드 docstring 작성.

### Notes
- Backward compatibility concerns: 기존에 하드코딩된 경로(`output/` 등)를 사용하는 사용자를 위해, 당분간은 새로운 `workspace` 디렉터리와 공존할 수 있음.
- Refactoring risk: 낮음.

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: 개발자 가이드(Developer Guide) 또는 아키텍처 문서.
- 전달하고자 하는 핵심 메시지: "모든 파일 입출력 경로는 `Workspace` 클래스를 통해 얻어야 합니다."

### Example Snippet (Optional)

```python
from chatbot_tester.common.workspace import Workspace

# 워크스페이스 초기화
ws = Workspace("./my_experiment_space")

# 새로운 실행 디렉터리 생성
run_id, run_path = ws.create_run()
print(f"Results will be saved to: {run_path}")

# 데이터셋 경로 조회
data_path = ws.get_dataset_dir("v1_dataset")
```
