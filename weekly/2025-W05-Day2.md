# Daily Framework Planning – 2025-W05-Day2

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common / All
- Current limitation: `generator`와 `runner` 모듈이 각각 별도의 `Message`, `TestSample` 클래스를 정의하여 사용하고 있어 코드 중복이 발생하고, 상호 운용 시 타입 변환이 필요함.
- Proposed improvement: `chatbot_tester.common` 패키지를 신설하고 핵심 데이터 모델(Data Models)을 중앙화하여 모든 모듈이 이를 참조하도록 리팩토링함.
- Why this matters for an SDK: 모듈 간 데이터 교환(예: Generator 출력을 Runner 입력으로 사용) 시 일관된 타입을 보장하고 유지보수성을 높임.

### Idea 2
- Affected layer: CLI / Orchestration
- Current limitation: Generator, Runner, Evaluator가 각각 별도의 진입점을 가지고 있어 사용자 경험이 파편화되어 있음.
- Proposed improvement: 단일 진입점 `chatbot-tester` (또는 `ct`) CLI를 도입하여 `ct gen`, `ct run`, `ct eval`과 같은 하위 명령어로 기능을 제공함.
- Why this matters for an SDK: 통합된 사용자 인터페이스를 제공하여 학습 곡선을 낮추고, 향후 파이프라인 오케스트레이션 기능을 위한 기반을 마련함.

### Idea 3
- Affected layer: Runner
- Current limitation: `RunResult`의 에러 처리가 딕셔너리나 문자열로 유연하게 처리되지만, 재시도 가능 여부나 에러 유형에 대한 표준화된 구조가 부족함.
- Proposed improvement: 표준화된 `Error` 객체 및 예외 계층 구조를 정의하여 모든 백엔드가 일관된 에러 정보를 반환하도록 함.
- Why this matters for an SDK: 자동화된 파이프라인에서 에러 발생 시 재시도 전략을 수립하거나 실패 원인을 분석하기 용이해짐.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: 공통 코어 라이브러리 구축 (Shared Core Library)
- Primary affected layer(s): Common

### Selection Rationale
- Architectural leverage: 통합 파이프라인(Unified Pipeline) 구현을 위해 필수적인 선결 과제임. 모듈 간 의존성 순환을 방지하고 코드 중복을 제거함.
- Impact on extensibility / reuse: 서드파티 확장이 코어 모델을 참조할 때 명확한 임포트 경로(`chatbot_tester.common`)를 제공함.
- Reduction of future complexity: 향후 추가될 오케스트레이터가 여러 모듈의 객체를 핸들링할 때 타입 불일치 문제를 사전에 방지함.

### Deferred Ideas (Brief)
- Idea 2 (Unified CLI): 중요하지만 코어 모델 정리가 선행되어야 내부 구현이 깔끔해짐.
- Idea 3 (Error Handling): Runner 리팩토링 시 함께 다룰 수 있는 범위.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
공통 데이터 모델 및 유틸리티 패키지 (`chatbot_tester.common`)

### Problem Statement
- 현재 `generator/types.py`와 `runner/models.py`에 거의 동일한 `Message`, `TestSample` 클래스가 중복 정의되어 있음.
- `evaluator` 또한 유사한 구조를 `domain.py`에 별도로 정의하고 있음.
- 이로 인해 모듈 간 데이터 전달 시 불필요한 변환 로직이 발생하며, 변경 사항이 양쪽에 반영되지 않을 위험이 있음.
- 라이브러리 사용자 및 프레임워크 유지보수자 모두에게 혼란을 줌.

### Design Approach (High-level)
- Core concept: "Single Source of Truth" - 데이터 모델을 한곳에서 정의.
- Key abstractions or interfaces:
  - `src/chatbot_tester/common/models.py`: `Message`, `TestSample` 등 핵심 엔티티 정의.
  - Pydantic 또는 `dataclasses`를 사용하여 직렬화/역직렬화(`to_dict`, `from_dict`) 표준화.
- Expected behavior:
  - `from chatbot_tester.common.models import Message` 형태로 모든 모듈에서 임포트 가능.

### MVP Scope
- Included in MVP:
  - `chatbot_tester.common` 패키지 생성.
  - `Message`, `TestSample` 클래스 이동 및 통합 (Runner의 `slots=True` 및 메서드 포함 버전 채택).
  - `generator` 및 `runner` 코드의 임포트 경로 수정.
- Explicitly excluded:
  - `evaluator/domain.py`의 `RunRecord` 등 Evaluator 전용 복합 모델 통합 (추후 진행).

### Optional / Future Extensions
- 공통 유틸리티(로깅, 설정 로더) 추가.
- Pydantic `BaseModel`로 완전 전환 (현재는 dataclass 사용 중).

### Acceptance Criteria
- [ ] `src/chatbot_tester/common/models.py` 파일이 존재함.
- [ ] `generator`와 `runner`가 로컬 정의 대신 공통 모델을 임포트하여 정상 작동함.
- [ ] 기존 테스트가 수정 없이(또는 임포트 수정만으로) 통과함.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Refactor] Extract shared data models to chatbot_tester.common`

### Task Breakdown
- [ ] Core implementation
  - Module: `chatbot_tester.common`
  - Summary: `src/chatbot_tester/common/models.py` 생성 및 `runner/models.py`의 `Message`, `TestSample` 클래스 이관.
- [ ] Refactoring
  - `runner/models.py`: 공통 모델 임포트로 대체. (Runner 전용 모델은 유지)
  - `generator/types.py`: 파일 삭제 또는 공통 모델 임포트로 대체(별칭 사용).
- [ ] API impact
  - Breaking change: No (내부 구조 변경이나, 공개 API인 경우 임포트 경로가 변경될 수 있음. 기존 경로에서 re-export하여 호환성 유지 권장).
  - Migration needed: No.
- [ ] Tests
  - Unit / Integration: 기존 테스트 수행.
- [ ] Documentation
  - Docstrings: 이동한 클래스에 독스트링 보강.

### Notes
- Backward compatibility concerns: 사용자가 `chatbot_tester.generator.types.Message`를 직접 임포트해서 쓰고 있을 수 있음. `types.py`를 남겨두고 `from ..common.models import Message`로 re-export하는 것이 안전함.
- Refactoring risk: 순환 참조 주의 (Common은 다른 모듈을 임포트하지 않아야 함).

---

## 5. Docs / Notes

### README Updates
- 개발자 가이드 섹션에 "Core Models" 위치 명시.

### Example Snippet (Optional)

```python
# Before
from chatbot_tester.generator.types import Message
# or
from chatbot_tester.runner.models import Message

# After
from chatbot_tester.common.models import Message
```
