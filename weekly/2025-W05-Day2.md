# 주간 프레임워크 계획 – 2025-W05-Day2

> 리포지토리: chatbot-tester
> 유형: 라이브러리 / SDK (Generator · Runner · Evaluator)
> 주안점: 아키텍처, API 디자인, 확장성, 재현성

---

## 1. Discovery (아이디어 발굴)

> 목표: 재사용 가능한 SDK에 적합한 프레임워크 수준의 개선 사항 식별

### 아이디어 1: 공통 모델 및 백엔드 시스템 추출 (Shared Core & Backend System)
- **영향 받는 레이어**: 공통 (Common) / Runner / Generator / Evaluator
- **현재 한계**: `ChatBackend`와 핵심 데이터 모델(`Message`, `RunRequest` 등)이 `runner` 패키지 내부에 고립되어 있음. Generator(데이터 증강)나 Evaluator(LLM 기반 평가)가 LLM을 사용하려면 `runner`에 의존해야 하는데, 이는 불필요한 의존성을 만들고 코드 중복을 초래함.
- **제안하는 개선**: `chatbot_tester.runner.backends`와 `chatbot_tester.runner.models`를 `chatbot_tester.common`으로 이동하여 모든 모듈이 공유할 수 있는 핵심 레이어를 구축함.
- **SDK로서 중요한 이유**: 프레임워크 전반에서 일관된 LLM 클라이언트 설정(키 관리, 재시도 정책 등)과 데이터 구조를 사용하여 개발 효율성과 유지보수성을 높임.

### 아이디어 2: 워크스페이스 및 아티팩트 관리자 (Workspace & Artifact Manager)
- **영향 받는 레이어**: 공통 (Common)
- **현재 한계**: 파일 경로나 디렉터리 생성이 각 모듈에서 문자열 조합으로 처리되어 관리가 어려움.
- **제안하는 개선**: 실행 ID 기반의 디렉터리 구조를 생성하고 파일을 관리하는 `WorkspaceManager` 클래스를 도입.
- **SDK로서 중요한 이유**: 실험 결과의 저장 위치를 체계적으로 관리하여 재현성을 보장함.

### 아이디어 3: 이벤트 버스 기반의 관찰 가능성 (Event Bus Observability)
- **영향 받는 레이어**: 공통 (Common)
- **현재 한계**: 실행 진행 상황이나 상태 변경을 실시간으로 추적하기 어려움. 로깅과 리포팅이 비즈니스 로직과 강하게 결합됨.
- **제안하는 개선**: `EventBus`를 도입하여 내부 상태 변경을 이벤트로 발행하고, 리포터나 UI가 이를 구독하게 함.
- **SDK로서 중요한 이유**: 컴포넌트 간 결합도를 낮추고 플러그인 형태의 관찰 도구(UI, 로거 등)를 쉽게 추가할 수 있음.

### 아이디어 4: 표준화된 로깅 및 추적 (Structured Logging & Telemetry)
- **영향 받는 레이어**: 전체
- **현재 한계**: 단순 텍스트 로깅(`print` 또는 `logging`)만으로는 병렬 실행이나 분산 환경에서의 디버깅이 어려움.
- **제안하는 개선**: JSON 포맷의 구조화된 로깅과 `trace_id`를 도입하여 요청의 전체 생명주기를 추적 가능하게 함.
- **SDK로서 중요한 이유**: 엔터프라이즈 환경 통합 및 대규모 실행 시 문제 해결 속도를 높임.

### 아이디어 5: 통합 구성 스키마 (Unified Configuration Schema)
- **영향 받는 레이어**: 공통 (Common)
- **현재 한계**: 모듈별로 서로 다른 구성 방식(CLI 인자, Dict, YAML 등)을 사용하여 사용자 혼란을 유발함.
- **제안하는 개선**: 모든 모듈의 설정을 아우르는 단일 Pydantic 모델 기반의 통합 스키마 정의.
- **SDK로서 중요한 이유**: 사용자에게 단일 진입점(`config.yaml`)을 제공하여 사용성을 개선하고 유효성 검사를 강화함.

---

## 2. Triage (우선순위 결정)

> 목표: 아키텍처 관점에서 가장 영향력 있는 아이디어 선정

### 선정된 아이디어
- **제목**: 공통 모델 및 백엔드 시스템 추출 (Shared Core & Backend System)
- **주요 영향 레이어**: 공통 (Common)

### 선정 근거
- **아키텍처적 레버리지**: 모든 모듈(Generator, Runner, Evaluator)의 기반이 되는 데이터 구조와 LLM 인터페이스를 통합하여, 상호 운용성을 확보함.
- **확장성/재사용성 영향**: 향후 "LLM-as-a-Judge"(Evaluator)나 "Synthetic Data Generation"(Generator) 기능을 구현할 때 Runner의 코드를 복제하거나 잘못된 의존성을 맺지 않고도 백엔드를 재사용할 수 있음.
- **미래 복잡성 감소**: 순환 참조 문제를 방지하고 코어 로직의 위치를 명확히 함.

### 보류된 아이디어 (요약)
- **워크스페이스 매니저**: 중요하지만, 코어 모델 분리가 선행되어야 파일 구조 정의가 더 명확해짐.
- **이벤트 버스**: 현재 규모에서는 직접 호출 방식도 관리 가능함. 복잡도가 증가하면 도입 고려.

---

## 3. Spec Draft (Top 1 Only)

### 기능 / 개선명
**공통 모델 및 백엔드 레지스트리 추출 (Core Models & Backend Registry Extraction)**

### 문제 정의 (Problem Statement)
- **어려움**: `runner` 패키지에 `Message`, `ChatResponse` 같은 핵심 데이터 모델과 `ChatBackend` 인터페이스가 포함되어 있음. 다른 모듈(예: `generator`)에서 LLM을 사용하려면 `runner`를 임포트해야 하는데, 이는 개념적으로 Runner가 아닌 Core에 속해야 할 기능임.
- **영향**: 프레임워크 유지보수자 (순환 참조, 코드 중복 관리의 어려움).

### 설계 접근 방식 (High-level)
- **핵심 개념**: "Runner는 Core를 사용한다", "Generator는 Core를 사용한다" 형태의 계층 구조 확립.
- **주요 추상화**:
  - `chatbot_tester.common.models`: `Message`, `TestSample`, `RunRequest`, `RunResult` 등 데이터 클래스.
  - `chatbot_tester.common.backends`: `ChatBackend` 추상 클래스 및 `BackendRegistry`.
- **예상 동작**:
  기존 코드:
  ```python
  from chatbot_tester.runner.models import Message
  from chatbot_tester.runner.backends.base import ChatBackend
  ```
  변경 후:
  ```python
  from chatbot_tester.common.models import Message
  from chatbot_tester.common.backends import ChatBackend
  ```

### MVP 범위
- **MVP 포함**:
  - `src/chatbot_tester/common/models.py` 생성 및 데이터 클래스 이동.
  - `src/chatbot_tester/common/backends/` 생성 및 `base.py` (Registry 포함) 이동.
  - `runner` 패키지가 `common`을 참조하도록 리팩토링.
- **명시적 제외**:
  - 개별 백엔드 구현체(예: OpenAI 백엔드 등)의 이동 (우선 인터페이스와 레지스트리만 이동, 구현체 이동은 추후 진행 가능).

### 옵션 / 향후 확장
- `common.utils` 등 기타 유틸리티 이동.
- 백엔드 플러그인 시스템(Entry Points)을 `common.backends`에 통합.

### 완료 조건 (Acceptance Criteria)
- [ ] `runner.models`의 모든 클래스가 `common.models`로 이동됨.
- [ ] `ChatBackend` 및 `BackendRegistry`가 `common.backends`에서 import 가능함.
- [ ] 기존 테스트가 리팩토링 후에도 통과함.
- [ ] 순환 참조 오류가 발생하지 않음.

---

## 4. Backlog Draft (Issue-Level)

### 제안된 GitHub Issue 제목
`[Refactor] Extract Core Models and Backend Interface to Common Package`

### 작업 세분화 (Task Breakdown)
- [ ] **Core implementation**
  - 모듈: `chatbot_tester.common`
  - 요약: `models.py` 생성 후 dataclass 이동. `backends` 패키지 생성 후 `ChatBackend`, `BackendRegistry` 이동.
- [ ] **Refactoring**
  - 모듈: `chatbot_tester.runner`
  - 요약: 내부 import 경로를 `chatbot_tester.runner.models`에서 `chatbot_tester.common.models` 등으로 수정.
- [ ] **API impact**
  - 파괴적 변경: Yes (내부 API 위치 변경).
  - 마이그레이션 필요: Yes (사용자 정의 Runner 스크립트가 있다면 import 경로 수정 필요).
- [ ] **Tests**
  - Unit / Integration: 기존 테스트 슈트 실행 및 통과 확인. `tests/runner/test_backends.py` 등의 import 수정.
- [ ] **Documentation**
  - Docstrings: 이동된 클래스의 모듈 경로 업데이트.

### 참고 사항
- **하위 호환성**: 외부 사용자에게 노출된 공개 API가 있다면 `chatbot_tester.runner.models`에서 `common.models`를 re-export하여 당분간 호환성을 유지할 수 있음 (`from ..common.models import *`).

---

## 5. Docs / Notes

### README 업데이트
- 필요 없음 (내부 구조 변경). 다만 개발자 가이드(`CONTRIBUTING.md` 등)가 있다면 구조 설명 업데이트 필요.

### 예제 스니펫

```python
# common/models.py
@dataclass
class Message:
    role: str
    content: str
    ...

# common/backends/base.py
class ChatBackend(abc.ABC):
    ...
```
