# 주간 프레임워크 계획 – 2025-W06-Day1

> 리포지토리: chatbot-tester
> 유형: 라이브러리 / SDK (Generator · Runner · Evaluator)
> 주안점: 아키텍처, API 디자인, 확장성, 재현성

---

## 1. Discovery (아이디어 발굴)

> 목표: 재사용 가능한 SDK에 적합한 프레임워크 수준의 개선 사항 식별

### 아이디어 1: 공통 코어 모듈(Common Core) 정립 및 중복 제거
- **영향 받는 레이어**: 전체 (Runner / Generator / Evaluator)
- **현재 한계**: `Message`, `TestSample` 등의 핵심 데이터 모델이 `runner/models.py`와 `generator/types.py`에 중복 정의되어 있음. 이로 인해 두 모듈 간 상호운용성이 떨어지고 코드 유지보수 비용이 증가함.
- **제안하는 개선**: `src/chatbot_tester/common` 패키지를 신설하고, 핵심 모델과 유틸리티를 이곳으로 통합하여 모든 서브모듈이 이를 참조하도록 리팩토링함.
- **SDK로서 중요한 이유**: 단일 진실 공급원(Single Source of Truth)을 확보하여 데이터 구조의 일관성을 보장하고, 사용자에게 일관된 타입 힌팅을 제공함.

### 아이디어 2: 백엔드(ChatBackend) 로직의 공통화
- **영향 받는 레이어**: Runner -> Generator
- **현재 한계**: LLM 호출 로직(`ChatBackend`)이 `runner`에 종속되어 있음. Generator가 합성 데이터 생성을 위해 LLM을 사용해야 할 경우, Runner 코드를 중복 구현하거나 불필요하게 Runner 전체에 의존해야 함.
- **제안하는 개선**: `ChatBackend` 인터페이스와 `BackendRegistry`를 `common` 또는 별도 모듈로 분리하여 Generator와 Runner가 공유할 수 있게 함.
- **SDK로서 중요한 이유**: 데이터 생성부터 실행, 평가까지 LLM 접근성을 일관되게 제공하여 프레임워크 내 재사용성을 극대화함.

### 아이디어 3: 통합 설정 객체 (Unified Experiment Configuration)
- **영향 받는 레이어**: 전체
- **현재 한계**: `PipelineOptions` (Generator)와 `RunnerOptions` (Runner)가 별개로 존재하여, 전체 실험을 한 번에 설정하기 어려움.
- **제안하는 개선**: 전체 실험 파이프라인을 아우르는 통합 설정 스키마를 정의하고, 이를 통해 각 단계의 설정을 주입받도록 함.
- **SDK로서 중요한 이유**: 사용자 입장에서 "실험"이라는 단위로 설정을 관리할 수 있게 하여 재현성과 사용성을 높임.

### 아이디어 4: 통합 CLI 엔트리포인트 (Unified CLI)
- **영향 받는 레이어**: CLI
- **현재 한계**: `python -m chatbot_tester.generator ...`, `python -m chatbot_tester.runner ...` 등 진입점이 분산되어 있음.
- **제안하는 개선**: `ct` 또는 `chatbot-tester`와 같은 단일 명령어로 하위 명령(subcommand)을 수행할 수 있는 통합 CLI 구축.
- **SDK로서 중요한 이유**: 사용자 경험(DX)을 개선하고 도구의 브랜드 정체성을 통합함.

### 아이디어 5: 이벤트 버스 도입 (Event Bus)
- **영향 받는 레이어**: Common / Runner / Evaluator
- **현재 한계**: 실행 상태 모니터링이나 로깅이 각 모듈에 결합되어 있어, 외부 시스템(예: 웹 UI, 실시간 대시보드)과의 연동이 어려움.
- **제안하는 개선**: 경량 이벤트 버스를 도입하여 주요 상태 변화(실행 시작, 완료, 에러 등)를 이벤트로 발행하고 구독할 수 있게 함.
- **SDK로서 중요한 이유**: 프레임워크의 관측성(Observability)을 높이고, 플러그인 시스템 확장의 기반이 됨.

---

## 2. Triage (우선순위 결정)

> 목표: 아키텍처 관점에서 가장 영향력 있는 아이디어 선정

### 선정된 아이디어
- **제목**: 공통 코어 모듈(Common Core) 정립 및 데이터 모델 통합
- **주요 영향 레이어**: Common (신규) / Runner / Generator

### 선정 근거
- **아키텍처적 레버리지**: 모든 모듈이 의존하는 가장 기초적인 데이터 구조를 정리함으로써, 향후 `ChatBackend` 이동이나 통합 파이프라인 구축의 기반을 마련함.
- **확장성/재사용성 영향**: Generator와 Runner가 동일한 객체를 주고받을 수 있게 되어 상호 운용성이 즉각적으로 향상됨.
- **미래 복잡성 감소**: 중복 코드를 제거하여 버그 발생 가능성을 낮추고, 타입 정의 변경 시 수정 범위를 한 곳으로 제한함.

### 보류된 아이디어 (요약)
- **백엔드 공통화**: Common 모듈이 먼저 존재해야 이동이 가능하므로 다음 단계로 연기.
- **통합 CLI**: 중요하지만, 내부 구조(Common)가 정리된 후 UI 계층을 통합하는 것이 효율적.
- **이벤트 버스**: 현재 단계에서는 오버엔지니어링일 수 있음. 기본 구조 안정화 후 고려.

---

## 3. Spec Draft (Top 1 Only)

### 기능 / 개선명
**공통 코어 모듈(Common Core) 및 모델 통합**

### 문제 정의 (Problem Statement)
- **어려움**: `Message`, `TestSample` 클래스가 `runner/models.py`와 `generator/types.py`에 중복 정의되어 있음. 서로 미묘하게 다른 구현(예: `to_dict` 메서드 유무, 필드 차이)을 가질 수 있어 데이터 교환 시 호환성 문제가 발생할 수 있음.
- **영향**: 라이브러리 유지보수자(중복 코드 관리), SDK 사용자(혼란스러운 import 경로).

### 설계 접근 방식 (High-level)
- **핵심 개념**: 프레임워크 전반에서 사용되는 도메인 모델과 유틸리티를 담는 `chatbot_tester.common` 패키지 생성.
- **주요 추상화**:
  - `src/chatbot_tester/common/models.py`: `Message`, `TestSample` 등 핵심 Pydantic/Dataclass 정의.
- **예상 동작**:
  - `from chatbot_tester.runner.models import TestSample` -> `from chatbot_tester.common.models import TestSample`로 변경 (Runner 내에서는 alias로 하위 호환성 유지 가능).
  - Generator와 Runner가 동일한 클래스 인스턴스를 공유.

### MVP 범위
- **MVP 포함**:
  - `src/chatbot_tester/common/` 디렉터리 및 `__init__.py` 생성.
  - `runner/models.py`의 `Message`, `TestSample` 등을 `common/models.py`로 이동.
  - `runner`와 `generator` 코드가 `common`을 참조하도록 수정.
- **명시적 제외**:
  - `ChatBackend` 등 로직이 포함된 컴포넌트 이동 (추후 진행).
  - 설정(Configuration) 객체 통합.

### 옵션 / 향후 확장
- `common/utils.py`로 공통 유틸리티 이동.
- `common/exceptions.py`로 공통 예외 이동.

### 완료 조건 (Acceptance Criteria)
- [ ] `src/chatbot_tester/common/models.py` 파일이 생성됨.
- [ ] `Message`, `TestSample` 클래스가 중복 없이 `common`에만 정의됨.
- [ ] 기존 테스트(`pytest`)가 수정 없이(또는 import 경로 수정 후) 모두 통과함.
- [ ] `generator`와 `runner`가 `common`의 모델을 사용함.

---

## 4. Backlog Draft (Issue-Level)

### 제안된 GitHub Issue 제목
`[Refactor] Establish Common Core Module and Unify Data Models`

### 작업 세분화 (Task Breakdown)
- [ ] **핵심 구현 (Core Implementation)**
  - 모듈: `src/chatbot_tester/common/models.py`
  - 요약: `runner/models.py`의 내용을 기반으로 공통 모델 파일 작성. `Message`, `TestSample` 등을 이곳으로 이동.
- [ ] **코드 리팩토링 (Refactoring)**
  - 대상: `src/chatbot_tester/runner/models.py`, `src/chatbot_tester/generator/types.py`
  - 요약: 기존 파일 내용을 삭제하고 `common`에서 import하여 re-export 하거나, 사용하는 측의 import 구문 변경.
- [ ] **API 영향**
  - 파괴적 변경: 예 (Import 경로 변경). 단, 기존 파일에서 re-export(`from ..common.models import ...`)를 해주면 하위 호환성 유지 가능.
  - 마이그레이션 필요: 내부적으로는 필요, 사용자 코드는 re-export 시 불필요.
- [ ] **테스트**
  - Unit: 모델 직렬화/역직렬화 테스트가 `common` 패키지 대상으로 수행되도록 이동.
- [ ] **문서화**
  - 개발 가이드에 "공통 모델은 `common`에 정의한다"는 원칙 추가.

### 참고 사항
- **하위 호환성**: `runner.models`와 `generator.types`는 당분간 `common`의 별칭(Alias)으로 남겨두어 기존 사용자 코드 깨짐 방지.
- **리팩토링 위험**: 순환 참조(Circular Dependency) 주의. `common`은 다른 하위 모듈(`runner`, `generator`)을 import 하지 않아야 함.

---

## 5. Docs / Notes

### README 업데이트
- **섹션**: 아키텍처 다이어그램 또는 모듈 설명 업데이트.
- **핵심 메시지**: "`chatbot-tester.common`은 프레임워크의 기반이 되는 데이터 구조를 제공합니다."

### 예제 스니펫 (Example Snippet)

```python
# Before
from chatbot_tester.runner.models import Message
# or
from chatbot_tester.generator.types import Message

# After (Recommended)
from chatbot_tester.common.models import Message
```
