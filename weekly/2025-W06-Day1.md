# Daily Framework Planning – 2025-W06-Day1

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator, Common)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common / Generator / Runner
- Current limitation: `generator.types`와 `runner.models`에 `Message`, `TestSample` 클래스가 중복 정의되어 있습니다. 서로 다른 타입을 사용하므로 데이터 교환 시 변환 로직이 필요하거나 타입 호환성 문제가 발생할 수 있습니다.
- Proposed improvement: `src/chatbot_tester/common` 패키지를 신설하고 핵심 도메인 모델(`Message`, `TestSample`)을 이곳으로 통합합니다.
- Why this matters for an SDK: 컴포넌트 간 데이터 계약(Contract)을 명확히 하고, 순환 참조(Circular Dependency) 없이 코드를 공유할 수 있는 기반이 됩니다.

### Idea 2
- Affected layer: Common
- Current limitation: 현재 데이터 클래스(`dataclass`)를 사용하고 있어 복잡한 유효성 검사나 직렬화/역직렬화 로직(`from_dict`, `to_dict`)을 수동으로 유지보수해야 합니다.
- Proposed improvement: 도메인 모델에 `Pydantic V2`를 도입하여 스키마 유효성 검사 및 JSON 직렬화를 자동화합니다.
- Why this matters for an SDK: 사용자 입력(YAML, JSON)에 대한 견고한 검증을 제공하고, SDK 사용자에게 명확한 에러 메시지를 제공할 수 있습니다.

### Idea 3
- Affected layer: Common
- Current limitation: 모듈별로 로깅 설정이 제각각이거나 `print` 문이 섞여 있어, 라이브러리로 사용 시 로그 제어가 어렵습니다.
- Proposed improvement: `chatbot_tester.common.logging` 모듈을 통해 구조화된 로거를 제공하고, 로그 레벨 및 포맷을 중앙에서 제어합니다.
- Why this matters for an SDK: 디버깅 용이성을 높이고, 라이브러리 사용자가 로그 출력을 자신의 애플리케이션 로그 시스템과 통합할 수 있게 합니다.

### Idea 4
- Affected layer: CLI
- Current limitation: `gen-dataset`, `runner`, `evaluator` 등 개별 진입점이 산재되어 있어 사용 편의성이 떨어집니다.
- Proposed improvement: 통합 CLI 엔트리포인트(`chatbot-tester` 또는 `ct`)를 구현하고 서브커맨드 패턴(`ct gen`, `ct run`)을 적용합니다.
- Why this matters for an SDK: 단일 진입점을 통해 사용자 경험(UX)을 통일하고, 버전 확인이나 도움말(`--help`) 제공을 표준화할 수 있습니다.

### Idea 5
- Affected layer: Evaluator
- Current limitation: 메트릭 계산 시 대형 언어 모델(LLM) 호출 비용이나 속도 문제가 발생할 수 있으나, 비동기 처리가 부분적으로만 적용되어 있습니다.
- Proposed improvement: `asyncio` 기반의 비동기 실행을 평가 로직 전반으로 확대합니다.
- Why this matters for an SDK: 대규모 데이터셋 평가 시 전체 실행 시간을 획기적으로 단축할 수 있습니다.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: `chatbot_tester.common` 패키지 신설 및 핵심 모델 통합
- Primary affected layer(s): Common, Generator, Runner

### Selection Rationale
- Architectural leverage: `generator`, `runner`, `evaluator`가 공통으로 의존할 수 있는 기반 레이어를 마련함으로써 코드 중복을 제거하고 의존성 방향을 정리합니다.
- Impact on extensibility / reuse: 향후 구현할 `Unified Pipeline Orchestrator`가 여러 컴포넌트를 조율하기 위해서는 공통된 데이터 구조(`Message`, `TestSample`)가 필수적입니다.
- Reduction of future complexity: 중복된 모델 정의로 인한 버그(예: 한쪽만 필드가 추가됨)를 원천 차단합니다.

### Deferred Ideas (Brief)
- Pydantic 도입: `common` 패키지로 모델을 이동하면서 자연스럽게 함께 검토/적용할 수 있습니다. (이번 작업의 구현 상세로 포함 가능)
- 통합 CLI: 모델과 로직이 정리된 후 UI 레이어를 통합하는 것이 효율적입니다.
- 로깅/비동기: 중요하지만 구조적 변경보다는 기능 개선에 가까우므로 후순위로 미룹니다.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
**Core Domain Model Unification in `chatbot_tester.common`**

### Problem Statement
- **현재 상황**: `src/chatbot_tester/generator/types.py`와 `src/chatbot_tester/runner/models.py`에 거의 동일한 `Message`, `TestSample` 클래스가 존재합니다.
- **문제점**:
  - 중복 코드 유지보수 비용 발생.
  - `runner`의 모델은 `to_dict`/`from_dict`가 구현되어 있으나 `generator`는 일부만 구현됨.
  - `evaluator`도 평가를 위해 동일한 구조가 필요하지만 현재는 별도 정의하거나 딕셔너리로 처리함.
- **영향**: 프레임워크 유지보수자, 일관된 타입을 기대하는 라이브러리 사용자.

### Design Approach (High-level)
- Core concept: "Shared Kernel" 패턴을 적용하여 모든 컴포넌트가 공유하는 `common` 패키지를 생성합니다.
- Key abstractions:
  - `src/chatbot_tester/common/models.py`: `Message`, `TestSample` 등 데이터 구조 정의.
  - `dataclasses` 대신 `Pydantic` `BaseModel`을 상속받아 유효성 검사 및 직렬화 기능 강화 (하위 호환성을 위해 `ConfigDict` 활용 가능).
- Expected behavior:
  - `from chatbot_tester.common.models import TestSample` 형태로 어디서든 임포트 가능.
  - `Generator`는 데이터를 생성하여 `TestSample` 객체 리스트를 반환.
  - `Runner`는 `TestSample`을 입력받아 실행.

### MVP Scope
- Included in MVP:
  - `src/chatbot_tester/common/__init__.py` 및 `src/chatbot_tester/common/models.py` 생성.
  - `Message`, `TestSample` (및 의존하는 `TokenUsage` 등) 클래스 이동 및 Pydantic 모델로 변환.
  - `generator` 및 `runner` 코드에서 기존 모델 참조를 `common` 모델로 변경.
- Explicitly excluded:
  - `PipelineConfig` 등 오케스트레이션 관련 설정 모델 (별도 작업으로 진행).
  - 로깅 유틸리티 이동.

### Optional / Future Extensions
- `common.io`: 파일 읽기/쓰기 유틸리티.
- `common.exceptions`: 공통 예외 클래스.

### Acceptance Criteria
- [ ] `src/chatbot_tester/common` 패키지가 생성됨.
- [ ] `generator`, `runner`의 테스트가 `common` 모델을 사용하여 통과함.
- [ ] `Message` 및 `TestSample`이 Pydantic 모델로 정의되어 유효성 검사가 동작함.
- [ ] 기존의 `to_dict`, `from_dict` 메서드(또는 호환되는 대안)가 제공됨.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Refactor] Extract core models to chatbot_tester.common package`

### Task Breakdown
- [ ] Core implementation
  - Module: `src/chatbot_tester/common/models.py`
  - Summary: `pydantic`을 사용하여 `Message`, `TestSample`, `TokenUsage` 정의. 기존 `dataclass` 필드와 메서드(`to_dict` 등) 호환성 확보.
- [ ] Refactor Generator
  - Update: `src/chatbot_tester/generator/types.py` 삭제 또는 `common` 임포트로 대체. `generator` 내부 코드 참조 수정.
- [ ] Refactor Runner
  - Update: `src/chatbot_tester/runner/models.py` 삭제 또는 `common` 임포트로 대체. `runner` 내부 코드 참조 수정.
- [ ] API impact
  - Breaking change: Yes (내부 모듈 위치 변경). 공개 API(`runner.run_job` 등)의 시그니처 타입이 변경됨.
  - Migration needed: Yes (라이브러리 사용자는 임포트 경로 수정 필요).
- [ ] Tests
  - Unit / Integration: 기존 테스트(`tests/`)가 리팩토링된 코드를 기반으로 정상 동작하는지 확인 및 수정.

### Notes
- Backward compatibility concerns: `Pydantic` 모델은 `dataclass`와 유사하게 동작하지만 `__init__` 동작이나 불변성(`frozen=True`) 설정에 주의해야 함. 기존 코드가 `slots=True`를 사용하고 있었으므로 성능 특성 확인 필요.
- Refactoring risk: 순환 참조가 발생하지 않도록 의존성 방향(Generator -> Common, Runner -> Common)을 철저히 확인해야 함.

---

## 5. Docs / Notes

### README Updates
- 개발자 가이드(Contributing) 섹션에 `chatbot_tester.common` 패키지의 역할과 의존성 규칙(Common은 다른 형제 패키지를 임포트하면 안 됨)을 명시.

### Example Snippet (Optional)

```python
# Before
from chatbot_tester.runner.models import TestSample, Message

# After
from chatbot_tester.common.models import TestSample, Message

# Pydantic usage
sample = TestSample(
    id="test-1",
    messages=[Message(role="user", content="Hello")]
)
print(sample.model_dump_json())
```
