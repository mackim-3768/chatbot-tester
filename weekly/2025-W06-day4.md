# Daily Framework Planning – 2025-W06-day4

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Generator
- Current limitation: `run_pipeline` 함수가 데이터를 로드하고, 정규화하고, 필터링하고, 저장하는 모든 로직을 하드코딩된 순서로 처리하고 있어, 중간에 새로운 변환(예: 데이터 증강, 번역, PII 마스킹)을 주입하기 어려움.
- Proposed improvement: Chain of Responsibility 패턴을 적용하여 파이프라인을 `PipelineStep`의 리스트로 구성하고, 사용자가 커스텀 스텝을 추가할 수 있도록 리팩토링함.
- Why this matters for an SDK: 사용자가 자신만의 데이터 전처리나 증강 로직을 플러그인처럼 추가할 수 있어야 프레임워크의 유연성이 확보됨.

### Idea 2
- Affected layer: Generator / Common
- Current limitation: Generator가 현재 동기(sync) 방식으로만 동작하여, LLM을 이용한 데이터 증강(Paraphrasing 등) 시 처리 속도가 느림.
- Proposed improvement: Generator 파이프라인 전체를 `asyncio` 기반으로 전환하거나, 비동기 실행을 지원하는 컨텍스트를 도입함.
- Why this matters for an SDK: 대량의 데이터셋을 생성하거나 변환할 때 성능 병목을 해소하고 Runner와 일관된 비동기 패턴을 유지하기 위함.

### Idea 3
- Affected layer: Runner
- Current limitation: Runner의 재시도(Retry) 로직이 단순 루프 기반으로 구현되어 있어, 복잡한 속도 제한(Rate Limiting)이나 지수 백오프(Exponential Backoff) 제어가 정교하지 않음.
- Proposed improvement: `tenacity`와 같은 라이브러리를 도입하거나 `aiolimiter`를 사용하여 백엔드별로 정교한 속도 제한 및 재시도 정책을 적용함.
- Why this matters for an SDK: API 비용 최적화 및 안정적인 대규모 실행을 위해 필수적인 기능임.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: Generator 변환 파이프라인 추상화 (Generator Transformation Pipeline Abstraction)
- Primary affected layer(s): Generator

### Selection Rationale
- Architectural leverage: 단일 함수에 집중된 로직을 작은 단위로 분리하여 테스트 용이성을 높이고 구조를 개선함.
- Impact on extensibility / reuse: 향후 '데이터 증강'이나 '포맷 변환' 같은 기능을 별도 모듈로 개발하여 쉽게 결합할 수 있게 됨.
- Reduction of future complexity: 파이프라인 로직이 복잡해질수록 유지보수가 어려워지는 문제를 사전에 방지함.

### Deferred Ideas (Brief)
- Idea 2 (Async Generator): 파이프라인 구조가 먼저 잡혀야 비동기 전환도 수월하므로 후순위로 미룸.
- Idea 3 (Runner Retry): 중요하지만 현재 Generator 개선이 우선순위가 더 높음.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
Generator 변환 파이프라인 (Generator Transformation Pipeline)

### Problem Statement
- 현재 `run_pipeline` 함수는 데이터 로딩부터 저장까지의 과정이 강결합되어 있음.
- 사용자가 데이터셋 생성 과정에 커스텀 로직(예: 특정 필드 암호화, 자동 번역)을 추가하려면 라이브러리 코드를 직접 수정해야 함.
- 이는 라이브러리 사용자에게 제약을 주며, 프레임워크 유지보수자 입장에서도 기능 확장을 어렵게 만듦.

### Design Approach (High-level)
- Core concept: 파이프라인을 일련의 `PipelineStep`으로 정의하고 순차적으로 실행하는 구조.
- Key abstractions or interfaces:
  - `PipelineStep`: `process(items: List[TestSample]) -> List[TestSample]` 메서드를 가진 추상 클래스 또는 프로토콜.
  - `GeneratorPipeline`: 스텝들을 등록하고 데이터를 통과시키는 관리자 클래스.
- Expected behavior:
  ```python
  pipeline = GeneratorPipeline([
      LoadRowsStep(options),
      CanonicalizeStep(options),
      FilterStep(options),
      SampleStep(options),
      SaveStep(options)
  ])
  pipeline.run()
  ```

### MVP Scope
- Included in MVP:
  - `PipelineStep` 인터페이스 정의.
  - 기존 로직을 `LoadRowsStep`, `CanonicalizeStep`, `FilterStep`, `SampleStep`, `SaveStep`으로 분리.
  - `run_pipeline` 함수가 내부적으로 `GeneratorPipeline`을 사용하도록 변경 (하위 호환성 유지).
- Explicitly excluded:
  - 사용자가 설정 파일(YAML)을 통해 동적으로 스텝을 구성하는 기능 (추후 구현).
  - 비동기 실행 지원.

### Optional / Future Extensions
- YAML 설정을 통한 파이프라인 동적 구성 (`steps` 리스트 정의).
- `ParallelStep`을 통한 병렬 처리.

### Acceptance Criteria
- [ ] `src/chatbot_tester/generator/pipeline.py`의 `run_pipeline` 로직이 스텝 단위로 분리됨.
- [ ] 기존 CLI(`gen-dataset`) 명령어가 동일하게 동작하며 결과물에 차이가 없음.
- [ ] `PipelineStep`을 상속받아 새로운 스텝을 정의할 수 있는 구조가 됨.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Daily][2025-W06-day4] Generator 파이프라인 리팩토링 (Chain of Responsibility 적용)`

### Task Breakdown
- [ ] Core implementation
  - Module: `chatbot_tester.generator.pipeline`
  - Summary: `PipelineStep` 추상 클래스 정의 및 기존 로직을 개별 스텝 클래스로 이동. `GeneratorPipeline` 클래스 구현.
- [ ] CLI changes (if any)
  - Command: 없음 (내부 로직 변경)
  - Flags / options: 없음
- [ ] API impact
  - Breaking change: No (`run_pipeline` 시그니처 유지)
  - Migration needed: No
- [ ] Tests
  - Unit / Integration: 파이프라인이 정상적으로 스텝을 실행하고 데이터를 처리하는지 검증하는 통합 테스트 추가.
- [ ] Documentation
  - README / Examples / Docstrings: `GeneratorPipeline` 및 스텝 확장에 대한 독스트링 추가.

### Notes
- Backward compatibility concerns: 기존 `PipelineOptions` 객체는 그대로 유지하여 호환성 보장.
- Refactoring risk: 데이터 처리 순서가 바뀌지 않도록 주의 필요.

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: 개발자 가이드 (Developer Guide)
- 전달하고자 하는 핵심 메시지: "Generator는 확장 가능한 파이프라인 구조를 따르므로, 필요한 경우 커스텀 스텝을 구현하여 추가할 수 있습니다."

### Example Snippet (Optional)

```python
class MyCustomStep(PipelineStep):
    def process(self, items):
        # 커스텀 로직 수행
        return [item for item in items if "secret" not in item.user_input]
```
