# Daily Framework Planning – 2025-W06-day4

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common
- Current limitation: `generator`와 `runner`, `evaluator`가 각각 `Message`, `TestSample` 등의 핵심 데이터 모델을 중복 정의하고 있어 코드 중복이 발생하고 모듈 간 호환성이 떨어짐.
- Proposed improvement: `src/chatbot_tester/common` 패키지를 신설하고 핵심 데이터 모델을 이곳으로 이동하여 단일 진실 공급원(Single Source of Truth)으로 관리.
- Why this matters for an SDK: SDK 전체의 일관성을 유지하고, 모듈 간 불필요한 데이터 변환 로직을 제거하여 유지보수성을 향상시킴.

### Idea 2
- Affected layer: Generator
- Current limitation: `pipeline.py` 내의 데이터 변환 로직(Canonicalize, Filter, Sample)이 절차적으로 하드코딩되어 있어, 새로운 변환 단계(예: 번역, 개인정보 마스킹)를 추가하거나 순서를 변경하기 어려움.
- Proposed improvement: 각 변환 단계를 독립적인 클래스로 분리하고, 이를 파이프라인 형태로 조합하여 실행할 수 있도록 `Transformation Pipeline` 구조 도입.
- Why this matters for an SDK: 데이터 생성 과정의 유연성을 확보하고, 사용자가 커스텀 변환 로직을 쉽게 주입할 수 있게 함.

### Idea 3
- Affected layer: All (Configuration)
- Current limitation: 데이터 생성, 테스트 실행, 평가 설정이 각각 다른 방식이나 파일로 관리되어, 하나의 실험을 온전히 재현하기 위해 여러 설정을 맞춰야 하는 불편함이 있음.
- Proposed improvement: `experiment.yaml`과 같은 통합 설정 포맷을 정의하여 데이터셋 생성부터 평가까지의 전체 라이프사이클을 단일 파일로 기술.
- Why this matters for an SDK: 실험의 재현성(Reproducibility)을 보장하고, 사용자 경험(DX)을 간소화함.

### Idea 4
- Affected layer: Common / IO
- Current limitation: 로그, 리포트, 데이터셋 저장이 로컬 파일 시스템(`pathlib.Path`)에 강하게 결합되어 있어 S3나 GCS 같은 클라우드 스토리지로 확장이 어려움.
- Proposed improvement: `ArtifactStore` 추상 인터페이스를 정의하고, 로컬/클라우드 구현체를 분리하여 주입 가능하도록 구조 개선.
- Why this matters for an SDK: 다양한 배포 환경(로컬 개발, CI/CD, 클라우드 배치 작업)을 유연하게 지원하기 위함.

### Idea 5
- Affected layer: Evaluator
- Current limitation: 사용할 평가 지표(Metric)들이 코드 내에 하드코딩되거나 정적으로 연결되어 있어, 설정 파일만으로 실행할 지표를 동적으로 구성하기 어려움.
- Proposed improvement: `MetricRegistry`를 도입하여 설정 파일(String 이름)을 기반으로 적절한 Metric 클래스를 동적으로 로드하고 인스턴스화하는 메커니즘 구현.
- Why this matters for an SDK: 평가 시스템의 확장성을 높이고, 플러그인 형태의 서드파티 Metric 지원을 용이하게 함.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: Shared Common Layer (Unified Data Models)
- Primary affected layer(s): Common, Generator, Runner, Evaluator

### Selection Rationale
- Architectural leverage: 모든 모듈이 의존하는 최하위 레이어(`Common`)를 정립하는 작업이므로, 이후 진행될 모든 기능 확장(CLI 통합, 파이프라인 개선 등)의 기반이 됨.
- Impact on extensibility / reuse: 데이터 모델의 불일치로 인한 어댑터 코드 작성을 방지하고, SDK 내부 통신을 표준화할 수 있음.
- Reduction of future complexity: 현재 `Generator`와 `Runner`에 산재된 중복 코드를 제거하여 기술 부채가 누적되는 것을 조기에 차단함.

### Deferred Ideas (Brief)
- Idea 2 (Generator Pipeline): `Common` 레이어가 정립된 후, 해당 모델을 기반으로 파이프라인을 리팩토링하는 것이 효율적임.
- Idea 3 (Unified Experiment Profile): CLI 통합 작업과 연계되어야 하므로, 모델 통합 이후로 미룸.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
Shared Common Layer 및 핵심 데이터 모델 통합

### Problem Statement
- 현재 `src/chatbot_tester/generator/types.py`와 `src/chatbot_tester/runner/models.py`에 `Message`, `TestSample` 등의 클래스가 중복 정의되어 있음.
- 이로 인해 `Generator`가 생성한 데이터를 `Runner`가 읽을 때, 또는 `Runner`의 결과를 `Evaluator`가 분석할 때 불필요한 타입 변환이나 필드 매핑이 필요함.
- 이는 코드의 복잡도를 높이고, 새로운 필드 추가 시 여러 파일을 동시에 수정해야 하는 유지보수 부담을 줌.

### Design Approach (High-level)
- Core concept: `src/chatbot_tester/common` 패키지를 신설하고, 도메인 핵심 모델을 정의.
- Key abstractions or interfaces:
  - `Message`: 대화의 기본 단위 (role, content 등).
  - `TestSample`: 테스트 케이스 단위 (id, messages, expected 등).
  - `RunResult`: 테스트 실행 결과.
- Expected behavior:
  - `Generator`, `Runner`, `Evaluator`는 자체적으로 모델을 정의하지 않고 `common` 모듈을 import 하여 사용.
  - 직렬화/역직렬화(`to_dict`, `from_dict`) 로직을 `common` 모델 내에 중앙화.

### MVP Scope
- Included in MVP:
  - `src/chatbot_tester/common` 디렉토리 및 `__init__.py` 생성.
  - `common/models.py`: `Message`, `TestSample` 클래스 이동 및 통합 (Pydantic 혹은 dataclass 사용, 현재는 dataclass 유지 권장).
  - `Generator` 및 `Runner` 코드에서 기존 모델 참조를 `common` 모델로 변경.
- Explicitly excluded:
  - `RunConfig`, `EvalScore` 등 각 모듈에 특화된 모델의 통합 (추후 검토).
  - `ArtifactStore` 등 유틸리티성 공통 모듈 구현.

### Optional / Future Extensions
- `Pydantic` 도입을 통한 엄격한 유효성 검사 (현재는 `dataclass` 사용 중).
- `common/io.py`를 추가하여 파일 입출력 로직 공통화.

### Acceptance Criteria
- [ ] `src/chatbot_tester/common/models.py`에 `Message`, `TestSample`이 정의되어야 함.
- [ ] `generator`와 `runner` 패키지 내의 중복된 모델 정의가 제거되어야 함.
- [ ] 기존 테스트(`pytest`)가 모델 변경 후에도 정상적으로 통과해야 함.
- [ ] `Generator`가 생성한 JSONL 파일을 `Runner`가 수정 없이 로드할 수 있어야 함.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Daily][2025-W06-day4] Common Layer 도입 및 핵심 모델 통합`

### Task Breakdown
- [ ] Core implementation
  - Module: `src/chatbot_tester/common`
  - Summary: `common` 패키지 생성 및 `models.py`에 `Message`, `TestSample` 구현.
- [ ] Refactoring
  - Module: `src/chatbot_tester/generator`
  - Summary: `types.py` 제거 또는 `common` 모델을 import 하도록 수정.
  - Module: `src/chatbot_tester/runner`
  - Summary: `models.py` 내 중복 클래스 제거 및 `common` 모델 import.
- [ ] Tests
  - Unit / Integration: 기존 테스트 코드가 변경된 import 경로와 네임스페이스를 반영하도록 수정 및 검증.
- [ ] Documentation
  - Docstrings: `common` 모델에 대한 명확한 Docstring 작성.

### Notes
- Backward compatibility concerns: 내부 모듈 구조 변경이므로 SDK 사용자에게는 Import 경로 변경의 영향이 있을 수 있음. (Major 버전 업데이트 혹은 Deprecation 경고 필요할 수 있으나, 현재는 초기 단계이므로 직접 변경).
- Refactoring risk: `Runner`의 `TestSample`은 `from_dict` 등의 메서드를 포함하고 있고, `Generator`는 단순 데이터 클래스임. `Runner`의 풍부한 기능을 `Common`으로 가져오는 방향으로 통합해야 함.

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: 없음 (내부 구조 변경).
- 전달하고자 하는 핵심 메시지: N/A

### Example Snippet (Optional)

```python
# Before
from chatbot_tester.generator.types import TestSample
# or
from chatbot_tester.runner.models import TestSample

# After
from chatbot_tester.common.models import TestSample
```
