# Daily Framework Planning – 2025-W06-day4

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common (All)
- Current limitation: `Message`와 `TestSample` 클래스가 `generator/types.py`와 `runner/models.py`에 중복 정의되어 있습니다. 서로 다른 메서드(`from_dict` 유무, `slots` 유무)를 가지고 있어 데이터 호환성 문제가 우려됩니다.
- Proposed improvement: `src/chatbot_tester/common` 패키지를 신설하고 핵심 데이터 모델을 이곳으로 통합합니다.
- Why this matters for an SDK: Generator가 생성한 데이터를 Runner가 실행하고 Evaluator가 평가하는 파이프라인에서, 데이터 모델의 단일 진실 공급원(Single Source of Truth)은 필수적입니다.

### Idea 2
- Affected layer: Generator
- Current limitation: `pipeline.py`의 데이터 처리 순서(Load -> Canonicalize -> Filter -> Sample -> Write)가 하드코딩되어 있어, 사용자가 커스텀 전처리(예: PII 마스킹, 번역)를 추가하기 어렵습니다.
- Proposed improvement: Transformation 단계를 추상화하여, 사용자가 원하는 처리 함수 목록을 주입할 수 있는 `Middleware` 또는 `Pipe` 패턴을 도입합니다.
- Why this matters for an SDK: 다양한 도메인의 챗봇 테스트 시, 데이터 정제 요구사항이 제각각이므로 유연한 파이프라인 구성이 필요합니다.

### Idea 3
- Affected layer: Runner
- Current limitation: 실행 과정의 로그나 상태 변화를 외부에서 관찰하기 어렵습니다. 현재는 단순 로깅에 의존하고 있습니다.
- Proposed improvement: 경량 Event Bus를 도입하여 `on_sample_start`, `on_sample_complete`, `on_error` 등의 이벤트를 발행하고, 외부 리스너가 이를 구독할 수 있게 합니다.
- Why this matters for an SDK: CLI 진행바, 웹 대시보드, 파일 리포트 등 다양한 출력 형식을 지원하기 위해 로직과 UI/Reporting을 분리해야 합니다.

### Idea 4
- Affected layer: Evaluator / Runner
- Current limitation: 실행(`run`)과 평가(`eval`) 설정이 `PipelineOptions`와 `RunConfig`로 분리되어 있어, 하나의 실험을 재현하기 위한 설정 관리가 번거롭습니다.
- Proposed improvement: 전체 실험 사이클을 정의하는 `ExperimentProfile` (YAML) 스키마를 정의하고 통합 관리합니다.
- Why this matters for an SDK: 실험의 재현성(Reproducibility)은 테스트 프레임워크의 핵심 가치이며, 설정 파일 하나로 전체 과정을 공유할 수 있어야 합니다.

### Idea 5
- Affected layer: Infrastructure (All)
- Current limitation: 파일 입출력이 `pathlib.Path`를 통해 로컬 파일시스템에 직접적으로 의존하고 있습니다.
- Proposed improvement: `ArtifactStore` 추상 클래스를 정의하여 로컬 파일시스템뿐만 아니라 S3, GCS 등 원격 저장소를 지원할 수 있도록 합니다.
- Why this matters for an SDK: CI/CD 환경이나 클라우드 기반의 대규모 테스트 환경에서는 로컬 스토리지보다 오브젝트 스토리지가 필수적입니다.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: 핵심 데이터 모델 통합 (Common Layer 구축)
- Primary affected layer(s): Common, Generator, Runner

### Selection Rationale
- Architectural leverage: 모든 모듈이 공유하는 데이터 구조를 통일함으로써, 향후 모듈 간 결합도를 낮추고 일관성을 보장하는 기반이 됩니다.
- Impact on extensibility / reuse: `common` 패키지는 추후 유틸리티나 기본 인터페이스를 공유하는 장소로 확장될 수 있습니다.
- Reduction of future complexity: 중복 코드를 제거하여 유지보수 비용을 줄이고, 한쪽만 수정되어 발생하는 버그를 원천 차단합니다.

### Deferred Ideas (Brief)
- Idea 2 (Pipeline): 모델 통합이 선행되어야 파이프라인의 입출력 타입도 명확해지므로 다음 순위로 미룹니다.
- Idea 3 (Event Bus): 실행 로직의 고도화 단계에서 다루는 것이 적절합니다.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
Unified Common Data Models (`src/chatbot_tester/common`)

### Problem Statement
- 현재 `Generator`와 `Runner`가 각각 `Message`, `TestSample` 클래스를 정의하여 사용하고 있습니다.
- `Runner` 쪽 모델은 `from_dict`와 `slots=True` 최적화가 되어 있는 반면, `Generator` 쪽은 단순 `dataclass`입니다.
- 이로 인해 Generator에서 생성한 JSONL 데이터를 Runner가 읽어들일 때, 파싱 로직이나 필드 정의가 달라질 위험이 있습니다.
- 프레임워크 유지보수자가 모델에 필드를 추가할 때 두 곳을 모두 수정해야 하는 불편함이 있습니다.

### Design Approach (High-level)
- Core concept: `src/chatbot_tester/common` 패키지를 생성하고, 도메인 핵심 모델을 이곳에 정의합니다.
- Key abstractions or interfaces:
  - `Message`: 대화 메시지 모델 (role, content, metadata 등)
  - `TestSample`: 테스트 케이스 모델 (id, messages, expected 등)
- Expected behavior:
  - `Generator`와 `Runner`는 자체 정의 모델 대신 `chatbot_tester.common.models`를 임포트하여 사용합니다.
  - 통합된 모델은 `dataclasses`를 기반으로 하되, 직렬화/역직렬화 헬퍼 메서드(`to_dict`, `from_dict`)를 모두 포함합니다.

### MVP Scope
- Included in MVP:
  - `src/chatbot_tester/common/models.py` 생성
  - `Message`, `TestSample` 클래스 이동 및 통합 (`slots=True` 적용, `from_dict` 포함)
  - `generator/types.py` 및 `runner/models.py`에서 해당 클래스 제거 및 임포트로 대체
- Explicitly excluded:
  - Pydantic 도입 (이번 단계에서는 기존 `dataclass` 구조를 유지하며 통합에 집중)
  - `RunResult` 등 Runner 전용 모델의 이동

### Optional / Future Extensions
- `pydantic` 모델로 전환하여 런타임 타입 검증 강화
- `ArtifactStore` 등 공통 인프라 코드 추가

### Acceptance Criteria
- [ ] `src/chatbot_tester/common/models.py`가 존재해야 함
- [ ] `Message`와 `TestSample`이 `common` 모듈에 정의되어 있어야 함
- [ ] `Generator`와 `Runner`의 기존 테스트가 수정 없이(또는 임포트 경로 수정만으로) 통과해야 함
- [ ] `from_dict` 메서드가 올바르게 동작하여 JSON 데이터를 객체로 복원할 수 있어야 함

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Daily][2025-W06-day4] Common 모듈 신설 및 데이터 모델 통합`

### Task Breakdown
- [ ] Core implementation
  - Module: `src/chatbot_tester/common`
  - Summary: `models.py` 파일을 생성하고 `Message`, `TestSample` 클래스를 통합 정의 (Runner 측의 `from_dict` 로직 채택)
- [ ] Refactoring (Generator)
  - Module: `src/chatbot_tester/generator/types.py`
  - Summary: 중복 클래스 제거 및 `common.models` 임포트 적용
- [ ] Refactoring (Runner)
  - Module: `src/chatbot_tester/runner/models.py`
  - Summary: 중복 클래스 제거 및 `common.models` 임포트 적용
- [ ] Tests
  - Unit / Integration: 모델의 직렬화/역직렬화 테스트를 `tests/common/test_models.py`에 추가하고, 기존 Gen/Run 테스트 통과 확인

### Notes
- Backward compatibility concerns: 내부 모듈 경로 변경이므로 공개 API가 아니라면 큰 문제는 없으나, 혹시 이 모델들을 직접 임포트해 쓰는 사용자가 있다면 안내가 필요함.
- Refactoring risk: 순환 참조(Circular Import) 주의. `common`은 다른 상위 모듈을 임포트하지 않도록 설계해야 함.

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: 개발자 가이드 (Developer Guide)
- 전달하고자 하는 핵심 메시지: "핵심 데이터 모델은 `src/chatbot_tester/common`에 위치하며, 모든 모듈은 이를 참조해야 한다."

### Example Snippet (Optional)

```python
from chatbot_tester.common.models import TestSample, Message

# Generator와 Runner 모두 동일한 클래스를 사용
sample = TestSample(
    id="test-001",
    messages=[Message(role="user", content="Hello")]
)
```
