# Daily Framework Planning – 2025-W06-day4

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Generator
- Current limitation: `pipeline.py`의 데이터 처리 로직(Load -> Canonicalize -> Filter -> Sample -> Write)이 함수 내에 하드코딩되어 있어, 처리 순서를 변경하거나 새로운 전처리 단계(예: PII 마스킹, 번역)를 추가하기 어려움.
- Proposed improvement: Chain of Responsibility 또는 Pipe 패턴을 적용하여, 개별 처리 로직을 `Transform` 클래스로 캡슐화하고 유연하게 구성할 수 있는 파이프라인 구조로 리팩터링함.
- Why this matters for an SDK: 라이브러리 사용자가 소스 코드를 수정하지 않고도 자신만의 데이터 변환 로직을 주입(Injection)할 수 있어야 확장성이 보장됨.

### Idea 2
- Affected layer: Evaluator
- Current limitation: `EmbeddingSimilarityMetric` 클래스가 내부적으로 `OpenAI` 클라이언트를 직접 인스턴스화하고 있어, 중앙화된 `ChatBackend` 레지스트리를 통한 설정 관리나 모킹(Mocking)이 불가능함.
- Proposed improvement: 임베딩 모델 호출을 위한 추상화(예: `EmbeddingBackend`)를 도입하거나 기존 `ChatBackend`를 확장하여, 인증 정보와 모델 교체를 통합적으로 관리하도록 개선함.
- Why this matters for an SDK: 테스트 환경 설정(API Key, Proxy, Base URL)을 일관되게 관리하고, OpenAI 외의 다양한 임베딩 제공자를 지원하기 위해 필수적임.

### Idea 3
- Affected layer: CLI (Runner/Evaluator)
- Current limitation: `main.py`에 `run` 및 `evaluate` 서브 커맨드가 정의되어 있으나, 실제 `Runner`와 `Evaluator` 로직과 연결되지 않은 상태임.
- Proposed improvement: `RunnerConfig` 및 `EvaluatorConfig`를 CLI 인자 및 설정 파일과 연동하여, `ct` 커맨드 하나로 생성부터 평가까지의 전체 워크플로우를 실행할 수 있도록 구현함.
- Why this matters for an SDK: 사용자가 복잡한 파이썬 스크립트 작성 없이 설정 파일만으로 전체 테스트 사이클을 자동화할 수 있어야 함.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: Generator Transformation Pipeline
- Primary affected layer(s): Generator

### Selection Rationale
- Architectural leverage: 데이터 생성 및 변환 과정의 유연성을 확보하면, 향후 다양한 데이터셋 요구사항(포맷 변환, 증강, 필터링 등)을 구조 변경 없이 수용할 수 있음.
- Impact on extensibility: 사용자가 `Transform` 인터페이스를 구현하여 파이프라인에 끼워 넣을 수 있게 되어 SDK로서의 활용도가 크게 향상됨.
- Reduction of future complexity: 현재 비대해질 가능성이 있는 `run_pipeline` 함수를 작고 테스트 가능한 단위(`Transform` 클래스들)로 분리하여 유지보수성을 높임.

### Deferred Ideas (Brief)
- Unified Embedding Backend: 중요하지만 현재 `Evaluator`가 동작은 하고 있으므로, 확장성 측면에서 Generator 파이프라인 개선이 더 시급하다고 판단함.
- CLI Command Completion: 기능 구현에 가까운 작업이며, Generator/Runner/Evaluator의 내부 API가 먼저 안정화된 후에 통합하는 것이 효율적임.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
Generator Transformation Pipeline

### Problem Statement
- 현재 `pipeline.py`는 데이터 로딩부터 저장까지의 절차가 고정되어 있음.
- 익명화(Anonymization)나 특정 필드 포맷팅 같은 커스텀 로직을 추가하려면 라이브러리 내부 코드를 수정해야 함.
- 이는 Generator를 확장 가능한 라이브러리로 사용하는 개발자에게 큰 제약사항임.

### Design Approach (High-level)
- Core concept: 데이터를 순차적으로 변환하는 `Transform` 객체들의 체인(Chain)으로 파이프라인을 구성함.
- Key abstractions or interfaces:
  - `Transform` (Abstract Base Class): `Iterable[TestSample]`을 입력받아 변환된 `Iterable[TestSample]`을 반환하는 인터페이스.
  - `Pipeline` (Class): 설정된 `Transform` 리스트를 순차적으로 실행하는 관리자.
- Expected behavior:
  - `Loader`가 데이터를 읽어오면, 미리 정의된(또는 주입된) `Transform`들이 순서대로 실행됨.
  - 각 단계는 독립적으로 테스트 가능함.

### MVP Scope
- Included in MVP:
  - `Transform` 추상 클래스 정의.
  - 기존 로직(`Canonicalize`, `Filter`, `Sample`)을 각각 `CanonicalizeTransform`, `FilterByLengthTransform`, `SampleTransform`으로 리팩터링.
  - `Pipeline` 클래스 구현 및 `run_pipeline` 함수가 이를 사용하도록 수정.
- Explicitly excluded:
  - 동적 플러그인 로딩 시스템 (MVP에서는 코드 레벨에서 리스트로 구성).
  - 병렬 처리 최적화.

### Acceptance Criteria
- [ ] `pipeline.py`의 절차적 로직이 클래스 기반으로 분리됨.
- [ ] 각 `Transform` 클래스에 대한 단위 테스트가 작성됨.
- [ ] 기존 `GeneratorConfig`를 사용하여 파이프라인이 정상적으로 동작함(하위 호환성 유지).

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Daily][2025-W06-day4] Generator Transformation Pipeline 리팩터링`

### Task Breakdown
- [ ] Core implementation
  - Module: `src/chatbot_tester/generator/transforms/`
  - Summary: `Transform` 베이스 클래스 정의 및 기존 파이프라인 로직(Canonicalize, Filter, Sample)을 개별 클래스로 이관.
- [ ] API impact
  - Breaking change: No (내부 구현 변경, `run_pipeline` 시그니처 유지 노력)
  - Migration needed: No
- [ ] Tests
  - Unit: `tests/generator/test_transforms.py` 작성하여 각 변환 로직 검증.
- [ ] Documentation
  - Docstrings: 각 `Transform` 클래스의 역할 및 입출력 명시.

### Notes
- Backward compatibility concerns: `PipelineOptions` 객체는 유지하되, 내부적으로 `Transform` 설정으로 매핑하는 로직이 필요함.
- Refactoring risk: 데이터 흐름(Stream vs List) 처리에 주의해야 함. 현재는 `List` 기반이나 향후 `Iterable` 기반으로 전환을 고려하여 인터페이스 설계.

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: Generator Architecture (Internal)
- 전달하고자 하는 핵심 메시지: Generator는 유연한 `Pipeline`과 `Transform` 구조로 이루어져 있어 확장이 용이함.

### Example Snippet (Optional)

```python
# Future Usage Plan (Not in MVP but capability goal)
from chatbot_tester.generator.pipeline import Pipeline
from chatbot_tester.generator.transforms import FilterByLengthTransform

pipeline = Pipeline(
    transforms=[
        FilterByLengthTransform(min_len=10),
        # CustomTransform()  # User can add this
    ]
)
pipeline.run(samples)
```
