# Daily Framework Planning – 2026-W02-Day4

> Repository: chatbot-tester
> Type: Library / SDK (Generator · Runner · Evaluator)
> Cadence: Daily (주차 내 일차별 사고 기록)
> Focus: Architecture, API design, extensibility, reproducibility

---

## Language Rule (MANDATORY)

- 본 문서의 **모든 내용은 반드시 한국어로 작성**합니다.
- 다음 항목만 예외적으로 영어 사용을 허용합니다:
  - 코드 블록
  - 파일 경로
  - 함수명 / 클래스명 / 모듈명
  - CLI 커맨드
  - 고유 명사 (예: OpenAI, CLI, SDK, Generator, Runner, Evaluator)
- 번역체가 아닌 **기술 기획 문서에 적합한 자연스러운 한국어**를 사용합니다.

---

## 1. Discovery (Ideas)

> Goal: 재사용 가능한 SDK 관점에서의 프레임워크 수준 개선 아이디어를
> **하루 단위로 축적**한다.

### Idea 1
- Affected layer: Common / Generator / Runner
- Current limitation: `Message`, `TestSample` 등 핵심 데이터 모델이 `generator/types.py`와 `runner/models.py`에 중복 정의되어 있습니다. `runner` 쪽은 `slots=True`나 `from_dict` 등이 구현되어 있으나 `generator`는 단순 `dataclass`로 남아 있어 구현 불일치가 발생합니다.
- Proposed improvement: `src/chatbot_tester/common/models.py`를 생성하여 핵심 모델을 통합하고, 각 모듈이 이를 임포트하여 사용하도록 리팩터링합니다.
- Why this matters for an SDK: 데이터 구조의 단일 진실 공급원(SSOT)을 확보해야 모듈 간 데이터 교환 시 호환성을 보장하고 유지보수 비용을 낮출 수 있습니다.

### Idea 2
- Affected layer: Common / All
- Current limitation: `OpenAI`, `Anthropic` 등 LLM 클라이언트 인스턴스화 로직이 각 모듈에 산재될 가능성이 높으며, 공통된 설정(API 키, 타임아웃 등) 관리가 어렵습니다.
- Proposed improvement: `chatbot_tester.common.backends` 패키지에 `BackendRegistry`와 표준 `ChatBackend` 인터페이스를 구현하여 모든 모듈이 동일한 방식으로 모델에 접근하도록 합니다.
- Why this matters for an SDK: Generator(합성 데이터 생성)와 Evaluator(LLM Judge)가 동일한 백엔드 설정을 공유할 수 있어 사용자 경험이 일관되게 유지됩니다.

### Idea 3
- Affected layer: CLI
- Current limitation: 현재 `generator`에만 `cli.py`가 명확히 존재하며, `runner`나 `evaluator`를 아우르는 통합 진입점이 부재합니다.
- Proposed improvement: 최상위 `cli.py` (또는 `ct` 커맨드)를 통해 `ct generate`, `ct run`, `ct evaluate`와 같이 하위 명령어로 기능을 노출하는 구조를 설계합니다.
- Why this matters for an SDK: 파편화된 스크립트 실행 방식을 개선하여 개발자 경험(DX)을 향상시킬 수 있습니다.

### Idea 4
- Affected layer: Runner / Evaluator
- Current limitation: 실행 결과나 평가 지표를 저장할 때 로컬 파일시스템 경로 처리가 하드코딩되거나 모듈별로 상이할 수 있습니다.
- Proposed improvement: `ArtifactStore` 추상화 계층을 도입하여 로컬 파일뿐만 아니라 S3, GCS 등 원격 저장소로의 확장을 미리 대비합니다.
- Why this matters for an SDK: 클라우드 환경에서의 실행 및 CI/CD 파이프라인 통합을 용이하게 합니다.

### Idea 5
- Affected layer: Evaluator
- Current limitation: 평가 로직이 정적인 리포트 생성에 머물러 있거나, 새로운 메트릭 추가 시 코드 수정이 필요할 수 있습니다.
- Proposed improvement: 플러그인 기반의 `Metric` 인터페이스를 강화하고, 설정 파일만으로 동적으로 메트릭을 로드하여 실행할 수 있는 구조를 만듭니다.
- Why this matters for an SDK: 사용자가 프레임워크 코드를 수정하지 않고도 커스텀 평가 지표를 주입할 수 있는 확장성을 제공합니다.

---

## 2. Triage

> Goal: **오늘 기준** 가장 아키텍처적 파급력이 큰 1개 아이디어를 선정한다.

### Selected Idea
- Title: Core Data Model Unification in Common
- Primary affected layer(s): Common, Generator, Runner

### Selection Rationale
- Architectural leverage: 모든 모듈이 의존하는 가장 기초적인 데이터 구조이므로, 이를 먼저 정리해야 이후의 `BackendRegistry`나 통합 CLI 작업이 수월해집니다.
- Impact on extensibility / reuse: 모델 정의가 한곳에 모이면 새로운 필드나 메서드 추가 시 전파가 즉시 이루어지므로 확장성이 좋아집니다.
- Reduction of future complexity: 중복 코드로 인한 버그(한쪽만 수정하고 다른 쪽은 누락하는 등)를 원천 차단할 수 있습니다.

### Deferred Ideas (Brief)
- Idea 2 (Backend Registry): 모델 통합 후 바로 다음 단계로 진행 예정.
- Idea 3 (Unified CLI): 기능이 안정화된 후 UX 개선 차원에서 접근하는 것이 좋음.

---

## 3. Spec Draft (Top 1 Only)

### Feature / Improvement Name
Core Model Refactoring to `chatbot_tester.common.models`

### Problem Statement
- 현재 `generator`와 `runner`가 각각 유사하지만 조금씩 다른 `Message`, `TestSample` 클래스를 가지고 있습니다.
- 이는 모듈 간 데이터 호환성을 저해하고, 공통 유틸리티(`ensure_messages` 등)의 재사용을 어렵게 만듭니다.
- 라이브러리 사용자 입장에서는 어떤 모듈의 객체를 사용해야 하는지 혼란스러울 수 있습니다.

### Design Approach (High-level)
- Core concept: `src/chatbot_tester/common/models.py`를 신설하여 공통 데이터 클래스를 정의합니다.
- Key abstractions or interfaces:
  - `Message`: 역할(role), 내용(content) 등을 담는 기본 단위. `runner`의 구현(`slots=True`, `to_dict`, `from_dict`)을 기준으로 통합.
  - `TestSample`: 테스트 케이스 단위.
  - `ensure_messages`: 메시지 리스트 변환 유틸리티.
- Expected behavior:
  - `from chatbot_tester.common.models import Message` 형태로 모든 모듈에서 임포트 가능.
  - `generator`와 `runner`의 기존 코드는 `common`을 참조하도록 변경.

### MVP Scope
- Included in MVP:
  - `Message`, `TestSample` 클래스 이동 및 통합.
  - `runner`에 있는 `RunResultStatus` 등의 열거형도 필요 시 이동 고려 (우선순위 낮음).
  - 기존 `generator/types.py` 및 `runner/models.py`의 참조 변경.
- Explicitly excluded:
  - `RunResult`, `RunRequest` 등 `runner` 전용 모델은 당분간 `runner` 패키지에 유지 (의존성이 `common`으로 향하도록만 수정).

### Optional / Future Extensions
- `pydantic` 모델로의 전환 (현재는 `dataclass` 사용 중).

### Acceptance Criteria
- [ ] `src/chatbot_tester/common/models.py` 파일이 생성됨.
- [ ] `generator`와 `runner`가 `common`의 모델을 임포트하여 정상 동작함.
- [ ] 기존 테스트가 수정 없이(또는 임포트 경로만 수정하여) 통과함.

---

## 4. Backlog Draft (Issue-Level)

### Suggested GitHub Issue Title
`[Framework][Refactor] Core data models (Message, TestSample) consolidation to common`

### Task Breakdown
- [ ] Core implementation
  - Module: `chatbot_tester.common`
  - Summary: `Message`, `TestSample`, `ensure_messages` 등을 포함하는 `models.py` 작성. `runner`의 구현체를 베이스로 채택.
- [ ] Refactoring
  - Module: `chatbot_tester.generator`
  - Summary: `types.py`에서 중복 정의 제거하고 `common.models` 임포트.
  - Module: `chatbot_tester.runner`
  - Summary: `models.py`에서 중복 정의 제거하고 `common.models` 임포트. `RunResult` 등은 `TestSample`을 `common`에서 가져다 쓰도록 수정.
- [ ] Tests
  - Unit / Integration: 기존 테스트 슈트 실행을 통해 회귀 테스트 수행. `common` 모듈에 대한 별도 단위 테스트 추가.

### Notes
- Backward compatibility concerns: 내부 모듈 간 리팩터링이므로 공개 API가 안정적이라면 큰 문제는 없으나, 혹시 `Message` 객체를 직접 임포트해서 쓰는 외부 코드가 있다면 경로 변경이 필요할 수 있음.
- Refactoring risk: 순환 참조(Circular Import) 주의 필요. `common`은 다른 모듈을 임포트하지 않도록 설계.

---

## 5. Docs / Notes

### README Updates
- 추가 또는 수정할 섹션: 개발자 가이드(Developer Guide) 또는 아키텍처 섹션.
- 전달하고자 하는 핵심 메시지: "모든 핵심 데이터 모델은 `chatbot_tester.common.models`에 정의되어 있으며, 이를 사용하는 것을 권장한다."

### Example Snippet (Optional)

```python
# Before
from chatbot_tester.generator.types import Message
# or
from chatbot_tester.runner.models import Message

# After
from chatbot_tester.common.models import Message

msg = Message(role="user", content="Hello")
```
